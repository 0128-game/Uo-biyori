<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>魚料理レシピ一覧</title>
<style>
/* ----------------------------------------------------- */
/* 0. 変数とリセット */
/* ----------------------------------------------------- */
:root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#2b6cb0;
    --muted:#666;
    --success:#2f855a;
    --danger:#c53030;
    --max-width:1400px; /* wrapに合わせるため1400pxに修正 */
    --shadow:0 6px 18px rgba(20,20,40,0.08); /* テーブルと同じ影 */
}
*{box-sizing:border-box}
body{
    font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo",sans-serif;
    margin:0;
    background:var(--bg);
    color:#222;
    padding:20px;
    display:flex;
    justify-content:center;
}
.wrap{
    width:100%;
    max-width:var(--max-width);
}
/* ----------------------------------------------------- */
/* 1. ヘッダーとコントロール */
/* ----------------------------------------------------- */
header{
    background:var(--card);
    padding:15px 25px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(20,20,40,0.05);
    margin-bottom:20px;
    display:flex;
    gap:12px;
    align-items:flex-end;
}
header h1{margin:0;font-size:1.6rem; color:var(--accent);}
.controls{
    margin-left:auto;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
}
input[type="search"], select{
    padding:9px 12px;
    border-radius:8px;
    border:1px solid #d6d8df;
    background:white;
}
button{
    padding:9px 14px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    transition:background-color 0.2s;
}
button:hover:not(:disabled){
    background: #23548f;
}
button:disabled{opacity:.6;cursor:not-allowed}

/* ----------------------------------------------------- */
/* 2. テーブル表示 */
/* ----------------------------------------------------- */
main{
    background:transparent;
}
#message{
    padding:10px 0;
    font-size:0.95rem;
}
table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    background:var(--card);
    border-radius:10px;
    overflow:hidden;
    box-shadow:var(--shadow);
}
thead th{
    text-align:left;
    padding:12px 14px;
    font-size:0.9rem;
    background:#f1f5f9;
    border-bottom:1px solid #e2e8f0;
    font-weight:600;
}
tbody td{
    padding:12px 14px;
    border-bottom:1px dashed #e2e8f0;
    vertical-align:top;
    font-size:0.95rem;
}
tbody tr:hover{background:rgba(43,108,176,0.03)}

.muted{color:var(--muted);font-size:0.85rem}
.recipe-thumb{
    width:80px;
    height:60px;
    object-fit:cover;
    border-radius:4px;
    display:block;
}

/* タイプタグ */
.tag-type{padding:4px 8px;border-radius:6px;font-size:0.8rem;font-weight:500;}
.type-recipe{background:#fff7ed;color:#b45309;border:1px solid #f6e7d0}
.type-pre{background:#f0fff4;color:var(--success);border:1px solid #d6f7df}

.actions button{
    margin-right:6px;
    padding:6px 10px;
    font-size:0.9rem;
    margin-bottom:4px;
}
.actions button:first-child{background:var(--accent);}
.actions button:nth-child(2){background:#a0aec0;}

/* ----------------------------------------------------- */
/* 3. 詳細ビュー */
/* ----------------------------------------------------- */
.detail-container{
    padding:25px;
    background:var(--card);
    border-radius:10px;
    box-shadow:var(--shadow);
}
.list-view #recipeTable{display:table;}
.list-view #detailContainer{display:none;}
.detail-view #recipeTable{display:none;}
.detail-view #detailContainer{display:block;}

.detail-header{
    padding-bottom:15px;
    border-bottom:1px solid #e2e8f0;
    margin-bottom:20px;
    position:relative;
}
.back-button{
    background:#909090 !important;
    color:white;
    padding:8px 15px;
    border-radius:4px;
    font-size:1em;
    position:absolute;
    top:0;
    right:0;
}
.detail-header h2{
    font-size:1.5rem;
    color:#343a40;
    margin-top:0;
    margin-bottom:5px;
    padding-right:150px;
}
.meta{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
}
.pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    background:#eef5ff;
    color:var(--accent);
    font-size:0.85rem;
    font-weight:500;
}
.pre-link-pill{
    background:#17a2b8 !important;
    color:white !important;
}
.detail-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:20px;
    margin-bottom:20px;
}
.detail-section{
    padding:15px;
    border:1px solid #eef2f7;
    border-radius:8px;
    background:var(--card);
}
.section-title{
    font-size:1.2rem;
    color:var(--accent);
    border-bottom:2px solid var(--accent);
    padding-bottom:5px;
    margin-top:0;
    margin-bottom:10px;
    font-weight:600;
}
#detailIngredients ul,
#detailMemo ul,
#detailProps ul{
    list-style:disc;
    padding-left:20px;
    margin-top:0;
    line-height:1.6;
}
.recipe-step-card{
    border:1px solid #eef2f7;
    padding:15px;
    border-radius:6px;
    background:var(--card);
    box-shadow:0 1px 3px rgba(0,0,0,0.05);
    line-height:1.6;
}
.recipe-step-card img{
    border-radius:4px;
    margin-bottom:10px;
}

/* ----------------------------------------------------- */
/* 4. モーダルスタイル（絞り込みUI） */
/* ----------------------------------------------------- */
#filterModal{
    position:fixed;
    inset:0;
    background:rgba(12,18,30,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:1000;
}
.modal-content{
    width:100%;
    max-width:760px;
    background:var(--card);
    border-radius:12px;
    padding:25px;
    box-shadow:0 10px 30px rgba(10,20,40,0.25);
    max-height:90vh;
    overflow:auto;
}
.modal-content h2{
    font-size:1.5rem;
    color:var(--accent);
    border-bottom:2px solid var(--accent);
    padding-bottom:8px;
    margin:0 0 20px 0;
}
.filter-group{
    border:1px solid #e2e8f0;
    padding:15px;
    margin-bottom:20px;
    border-radius:8px;
    background-color:#fcfdfe;
}
.filter-group legend{
    font-weight:700;
    padding:0 10px;
    color:#343a40;
    font-size:1.1em;
}
.filter-hint{
    font-size:0.85em;
    color:var(--muted);
    margin:5px 0 10px 0;
}
.filter-item{
    display:inline-block;
    margin-right:25px;
    margin-bottom:8px;
}
.modal-footer{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    padding-top:20px;
    border-top:1px solid #e2e8f0;
    margin-top:10px;
}
.modal-footer button{
    padding:10px 20px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:1em;
}
#filterClearBtn{
    background:#a0aec0;
    color:white;
}
#applyFilterBtn{
    background:var(--accent);
    color:white;
}
@media(max-width:768px){
    .controls{justify-content:space-between;}
    header{flex-direction:column;align-items:flex-start;gap:10px;}
    .detail-grid{grid-template-columns:1fr;}
    .back-button{position:static;margin-top:10px;float:none;display:block;width:100%;text-align:center;}
    .detail-header h2{padding-right:0;}
}
</style>
</head>
<body>
<div class="wrap" id="wrap">
    <header>
        <h1>魚のレシピリスト</h1>
        <div class="controls">
            <input type="search" id="q" placeholder="タイトル, 材料, 魚名などで検索">
            <select id="filterType">
                <option value="all">全て</option>
                <option value="recipe">レシピ</option>
                <option value="pre">下処理</option>
            </select>
            <button id="filterOpenBtn">絞り込み設定</button>
            <button id="proposeOpenBtn">レシピ提案</button>
            <select id="sortBy">
                <option value="No" selected>No順 (昇順)</option>
                <option value="-No">No順 (降順)</option>
                <option value="-difficulty">難易度 (高順)</option>
                <option value="difficulty">難易度 (低順)</option>
                <option value="-cost">費用 (高順)</option>
                <option value="cost">費用 (低順)</option>
                <option value="-time">時間 (長順)</option>
                <option value="time">時間 (短順)</option>
                <option value="title">タイトル</option>
            </select>
            <button id="reloadBtn">データ再読み込み</button>
        </div>
    </header>
    <main id="app">
        <p id="message" class="muted">データを読み込み中です...</p>
        <table id="recipeTable">
            <thead>
                <tr>
                    <th style="width:80px">No</th>
                    <th style="width:80px">Type</th>
                    <th style="width:80px">Picture</th>
                    <th>Title / flavortxt</th>
                    <th style="width:160px">魚 / 旬</th>
                    <th style="width:120px">難易度 / 時間</th>
                    <th style="width:120px">費用 / その他情報</th>
                    <th style="width:110px">操作</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        <!-- 詳細コンテナ（デフォルトは非表示） -->
        <div id="detailContainer" class="detail-container hidden" aria-hidden="true" style="display:none;">
            <div class="detail-header">
                <button id="backToListBtn" class="back-button">← リストに戻る</button>
                <h2 id="detailTitle"></h2>
                <div id="detailSubtitle" class="muted"></div>
                <div id="detailImageContainer" style="text-align:center; margin-bottom:15px;"></div>
                <div id="detailMeta" class="meta"></div>
            </div>

            <div class="detail-grid">
                <div class="detail-section">
                    <h3 class="section-title">材料 (Ingredients)</h3>
                    <div id="detailIngredients"></div>
                </div>
                <div class="detail-section" id="propsSection">
                    <h3 class="section-title">道具 (Props)</h3>
                    <div id="detailProps"></div>
                </div>
                <div class="detail-section">
                    <h3 class="section-title">下処理・調理法 (Recipe / Pre-Process)</h3>
                    <div id="detailRecipe"></div>
                </div>
            </div>

            <div class="detail-section">
                <h3 class="section-title">メモ (Memo)</h3>
                <div id="detailMemo"></div>
            </div>
        </div>
    </main>
</div> <!-- /.wrap -->

<!-- 絞り込みモーダル -->
<div id="filterModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
        <h2 id="filterTitle">絞り込み設定</h2>
        <div id="filterContent">
            <!-- JSで動的にフィルターUIを生成します -->
        </div>
        <div class="modal-footer">
            <button id="filterClearBtn" type="button">フィルター解除</button>
            <button id="applyFilterBtn" type="button" class="primary-button">適用して閉じる</button>
        </div>
    </div>
</div>

<!-- レシピ提案モーダル（重複は取り除き、ここでは1つ） -->
<div id="proposeModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="proposeTitle">
  <div class="modal-content">
    <button class="close-propose" id="closeProposeBtn" aria-label="閉じる">&times;</button>

    <!-- 左側：条件（見出し＋2列グリッド） -->
    <div class="modal-left">

      <h2 id="proposeTitle">レシピ提案</h2>

      <!-- 食数選択 -->
      <fieldset class="propose-group">
        <legend>食数選択</legend>
        <div class="grid-row">
          <div class="grid-label">種類</div>
          <div class="grid-control">
            <label><input type="radio" name="meals" value="1" checked> 1食</label>
            <label><input type="radio" name="meals" value="3"> 1日(3食)</label>
            <label><input type="radio" name="meals" value="9"> 3日(9食)</label>
            <label><input type="radio" name="meals" value="custom"> カスタム</label>
          </div>
        </div>
        <div class="grid-row" id="customMealRow" style="margin-top:8px; display:none;">
          <div class="grid-label">カスタム値</div>
          <div class="grid-control">
            <input type="number" id="customMealInput" min="1" max="99" value="1">
            <button id="customMealConfirm">決定</button>
          </div>
        </div>
      </fieldset>

      <!-- 設定方法 -->
      <fieldset class="propose-group" id="modeFieldset">
        <legend>設定方法選択</legend>
        <div class="grid-row">
          <div class="grid-label">方法</div>
          <div class="grid-control">
            <label><input type="radio" name="mode" value="all" checked> 一斉設定</label>
            <label><input type="radio" name="mode" value="each"> 個別設定</label>
          </div>
        </div>
      </fieldset>

      <!-- カウンター -->
      <fieldset class="propose-group" id="counterContainer" style="display:none;">
        <legend>食数表示窓</legend>
        <div class="grid-row">
          <div class="grid-label">現在</div>
          <div class="grid-control counter">
            <button id="leftBtn" type="button">←</button>
            <span id="counterValue">1</span>
            <button id="rightBtn" type="button">→</button>
          </div>
        </div>
      </fieldset>

      <!-- 使いたい魚選択 -->
      <fieldset class="propose-group">
        <legend>使いたい魚選択</legend>
        <div class="grid-row">
          <div class="grid-label">指定</div>
          <div class="grid-control">
            <label><input type="radio" name="includeFishMode" value="none" checked> 指定しない</label>
            <label><input type="radio" name="includeFishMode" value="specify"> 指定する</label>
          </div>
        </div>
        <div class="grid-row" id="includeFishRow" style="margin-top:8px; display:none;">
          <div class="grid-label">魚</div>
          <div class="grid-control" id="includeFishContainer"></div>
        </div>
      </fieldset>

      <!-- 除外する魚選択 -->
      <fieldset class="propose-group">
        <legend>除外する魚選択</legend>
        <div class="grid-row">
          <div class="grid-label">指定</div>
          <div class="grid-control">
            <label><input type="radio" name="excludeFishMode" value="none" checked> 指定しない</label>
            <label><input type="radio" name="excludeFishMode" value="specify"> 指定する</label>
          </div>
        </div>
        <div class="grid-row" id="excludeFishRow" style="margin-top:8px; display:none;">
          <div class="grid-label">魚</div>
          <div class="grid-control" id="excludeFishContainer"></div>
        </div>
      </fieldset>

      <!-- 難易度 -->
      <fieldset class="propose-group">
        <legend>難易度選択</legend>
        <div class="grid-row">
          <div class="grid-label">設定</div>
          <div class="grid-control">
            <label><input type="radio" name="difficulty" value=""> 制限なし</label>
            <label><input type="radio" name="difficulty" value="1"> 1以下</label>
            <label><input type="radio" name="difficulty" value="2"> 2以下</label>
            <label><input type="radio" name="difficulty" value="3"> 3以下</label>
            <label><input type="radio" name="difficulty" value="custom"> カスタム</label>
          </div>
        </div>
        <div class="grid-row" id="customDiffRow" style="margin-top:8px; display:none;">
          <div class="grid-label">カスタム</div>
          <div class="grid-control">
            <input type="number" id="customDiffInput" min="1" max="5" placeholder="最大難易度">
            <button id="customDiffConfirm">決定</button>
          </div>
        </div>
      </fieldset>

      <!-- 時間 -->
      <fieldset class="propose-group">
        <legend>時間選択 (分)</legend>
        <div class="grid-row">
          <div class="grid-label">設定</div>
          <div class="grid-control">
            <label><input type="radio" name="time" value=""> 制限なし</label>
            <label><input type="radio" name="time" value="15"> 15分以内</label>
            <label><input type="radio" name="time" value="30"> 30分以内</label>
            <label><input type="radio" name="time" value="60"> 60分以内</label>
            <label><input type="radio" name="time" value="custom"> カスタム</label>
          </div>
        </div>
        <div class="grid-row" id="customTimeRow" style="margin-top:8px; display:none;">
          <div class="grid-label">カスタム</div>
          <div class="grid-control">
            <input type="number" id="customTimeInput" min="1" max="120" placeholder="最大時間">
            <button id="customTimeConfirm">決定</button>
          </div>
        </div>
      </fieldset>

      <!-- 費用 -->
      <fieldset class="propose-group">
        <legend>費用選択 (円)</legend>
        <div class="grid-row">
          <div class="grid-label">設定</div>
          <div class="grid-control">
            <label><input type="radio" name="cost" value=""> 制限なし</label>
            <label><input type="radio" name="cost" value="500"> ¥500以下</label>
            <label><input type="radio" name="cost" value="1000"> ¥1000以下</label>
            <label><input type="radio" name="cost" value="2000"> ¥2000以下</label>
            <label><input type="radio" name="cost" value="custom"> カスタム</label>
          </div>
        </div>
        <div class="grid-row" id="customCostRow" style="margin-top:8px; display:none;">
          <div class="grid-label">カスタム</div>
          <div class="grid-control">
            <input type="number" id="customCostInput" min="100" max="5000" placeholder="最大費用">
            <button id="customCostConfirm">決定</button>
          </div>
        </div>
      </fieldset>

      <div style="height:12px;"></div>
      <div style="text-align:center; padding:12px;">
        <button id="proposeGenerateBtn" style="width:60%;">提案を生成</button>
      </div>

    </div> <!-- /.modal-left -->

    <!-- 右側：サマリーパネル -->
    <div id="summaryPanel" aria-live="polite">
      <!-- summary content injected by JS -->
      <h3 style="text-align:center;">提案プレビュー</h3>
      <div id="proposalPreview" style="padding:10px;"></div>
    </div>

  </div> <!-- /.modal-content -->
</div>

<!-- 提案結果モーダル -->
<div id="proposalModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>レシピ提案結果</h2>
    <div id="proposalResults"></div>
    <div class="modal-buttons" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="backToSettingsBtn">戻る</button>
      <button id="closeProposalBtn">閉じる</button>
    </div>
  </div>
</div>

<!-- ↓ 第3部でスクリプト本体を続けます（イベント、データ読み込み、フィルター処理、詳細表示など） -->
<!-- ===== 第3部：スクリプト（完全版） ===== -->
<script>
/*
 * 完全修正版スクリプト
 * - 第1部/第2部で定義した要素群に合わせて動作します
 * - データ読み込み、フィルターUI生成、フィルタ適用、詳細表示、モーダル操作、提案生成まで含む
 */

(function(){
    // ----- 設定 -----
    const tryPaths = [
        'docs/recipes.json',
        './docs/recipes.json',
        '/recipes.json',
        './recipes.json'
    ];

    // ----- DOM 要素 -----
    const wrap = document.getElementById('wrap');
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const filterType = document.getElementById('filterType');
    const sortBy = document.getElementById('sortBy');
    const reloadBtn = document.getElementById('reloadBtn');
    const message = document.getElementById('message');

    const filterOpenBtn = document.getElementById('filterOpenBtn');
    const filterModal = document.getElementById('filterModal');
    const filterContent = document.getElementById('filterContent');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const filterClearBtn = document.getElementById('filterClearBtn');

    const detailContainer = document.getElementById('detailContainer');
    const detailTitle = document.getElementById('detailTitle');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailImageContainer = document.getElementById('detailImageContainer');
    const detailMeta = document.getElementById('detailMeta');
    const detailIngredients = document.getElementById('detailIngredients');
    const detailRecipe = document.getElementById('detailRecipe');
    const detailMemo = document.getElementById('detailMemo');
    const backToListBtn = document.getElementById('backToListBtn');
    const detailProps = document.getElementById('detailProps');
    const propsSection = document.getElementById('propsSection');

    // propose modal elements
    const proposeOpenBtn = document.getElementById('proposeOpenBtn');
    const proposeModal = document.getElementById('proposeModal');
    const closeProposeBtn = document.getElementById('closeProposeBtn');
    const proposeGenerateBtn = document.getElementById('proposeGenerateBtn');
    const includeFishRow = document.getElementById('includeFishRow');
    const excludeFishRow = document.getElementById('excludeFishRow');
    const includeFishContainer = document.getElementById('includeFishContainer');
    const excludeFishContainer = document.getElementById('excludeFishContainer');
    const proposalPreview = document.getElementById('proposalPreview');
    const proposalResults = document.getElementById('proposalResults');
    const proposalModal = document.getElementById('proposalModal');
    const backToSettingsBtn = document.getElementById('backToSettingsBtn');
    const closeProposalBtn = document.getElementById('closeProposalBtn');

    // propose form controls (many are in DOM with names; we'll query when needed)
    // counter controls
    const counterContainer = document.getElementById('counterContainer');
    const customMealRow = document.getElementById('customMealRow');
    const customMealInput = document.getElementById('customMealInput');
    const customMealConfirm = document.getElementById('customMealConfirm');
    const counterValue = document.getElementById('counterValue');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');

    // custom inputs for difficulty/time/cost (in DOM)
    const customDiffRow = document.getElementById('customDiffRow');
    const customTimeRow = document.getElementById('customTimeRow');
    const customCostRow = document.getElementById('customCostRow');

    // ----- データ -----
    let rawData = null;
    let flatList = [];

    // フィルター状態（fish-name は Set）
    let activeFilters = {
        'fish-name': new Set(),
        difficulty: null,
        time: null,
        cost: null
    };

    const DIFFICULTY_OPTIONS = ['1','2','3','4','5'];
    const TIME_OPTIONS = [15,30,60];
    const COST_OPTIONS = [500,1000,2000];
    const TIME_MAX = 120;
    const COST_MAX = 5000;

    // ----- ユーティリティ -----
    function elText(tag, text, cls){
        const el = document.createElement(tag);
        if (cls) el.className = cls;
        el.textContent = (text === undefined || text === null) ? '' : String(text);
        return el;
    }
    function joinIfArray(val){
        if (Array.isArray(val)) return val.join(', ');
        if (val === undefined || val === null) return '';
        return String(val);
    }

    // 安全な fetch 複数候補からの読み込み
    async function fetchAny(paths){
        for (const p of paths){
            try {
                const res = await fetch(p, {cache: "no-store"});
                if (!res.ok) continue;
                const json = await res.json();
                return json;
            } catch(e){
                console.warn('fetch failed for', p, e);
            }
        }
        throw new Error('recipes.json を見つけられませんでした。期待する場所: ' + paths.join(', '));
    }

    // flatList を作成
    function buildFlatList(data){
        const list = [];
        if (!data || typeof data !== 'object') return list;
        const recipes = data.recipes || {};
        for (const key of Object.keys(recipes)){
            const item = Object.assign({}, recipes[key]);
            item._type = 'recipe';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        const pres = data.preparations || {};
        for (const key of Object.keys(pres)){
            const item = Object.assign({}, pres[key]);
            item._type = 'pre';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        return list;
    }

    function clearTable(){ if (tbody) tbody.innerHTML = ''; }

    // ----- フィルターUI生成ヘルパー（第1/2部と同等） -----
    function createCheckboxGroup(title, key, values, hintText = ''){
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';
        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);
        if (hintText){
            const hint = elText('p', hintText, 'filter-hint');
            fieldset.appendChild(hint);
        }
        values.forEach(value => {
            const strValue = String(value);
            const id = `${key}-${strValue.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const div = document.createElement('div');
            div.className = 'filter-item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = strValue;
            checkbox.dataset.filterKey = key;
            if (activeFilters[key] && activeFilters[key].has(strValue)) checkbox.checked = true;
            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = strValue;
            div.appendChild(checkbox);
            div.appendChild(label);
            fieldset.appendChild(div);
        });
        return fieldset;
    }

    function createRadioGroup(title, key, values, hintText = '', labels = null, type = 'radio', inputProps = {}){
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';
        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);
        if (hintText){
            const hint = elText('p', hintText, 'filter-hint');
            fieldset.appendChild(hint);
        }

        const radioDiv = document.createElement('div');
        radioDiv.className = 'radio-options-container';

        const allRadioDiv = document.createElement('div');
        allRadioDiv.className = 'filter-item';
        const allId = `${key}-all`;
        const allRadio = document.createElement('input');
        allRadio.type = 'radio';
        allRadio.id = allId;
        allRadio.name = key;
        allRadio.value = '';
        allRadio.dataset.filterKey = key;
        if (activeFilters[key] === null || activeFilters[key] === '') allRadio.checked = true;
        const allLabel = document.createElement('label');
        allLabel.htmlFor = allId;
        allLabel.textContent = '制限なし';
        allRadioDiv.appendChild(allRadio);
        allRadioDiv.appendChild(allLabel);
        radioDiv.appendChild(allRadioDiv);

        values.forEach((value, index) => {
            const strValue = String(value);
            const id = `${key}-${strValue}`;
            const labelText = labels ? labels[index] : strValue;
            const div = document.createElement('div');
            div.className = 'filter-item';
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = id;
            radio.name = key;
            radio.value = strValue;
            radio.dataset.filterKey = key;
            if (activeFilters[key] === strValue) radio.checked = true;
            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = labelText;
            div.appendChild(radio);
            div.appendChild(label);
            radioDiv.appendChild(div);
        });

        // カスタム入力（時間・費用用）
        let inputContainer = null;
        if (type === 'radio-input'){
            const customRadioDiv = document.createElement('div');
            customRadioDiv.className = 'filter-item';
            const customId = `${key}-custom-radio`;
            const customRadio = document.createElement('input');
            customRadio.type = 'radio';
            customRadio.id = customId;
            customRadio.name = key;
            customRadio.value = 'CUSTOM';
            customRadio.dataset.filterKey = key;
            const isCustomSelected = activeFilters[key] !== null && activeFilters[key] !== '' && !values.map(String).includes(activeFilters[key]);
            if (isCustomSelected) customRadio.checked = true;
            const customLabel = document.createElement('label');
            customLabel.htmlFor = customId;
            customLabel.textContent = 'カスタム値を入力';
            customRadioDiv.appendChild(customRadio);
            customRadioDiv.appendChild(customLabel);
            radioDiv.appendChild(customRadioDiv);

            fieldset.appendChild(radioDiv);

            inputContainer = document.createElement('div');
            inputContainer.className = 'filter-input-container';
            inputContainer.style.marginTop = '10px';
            inputContainer.style.borderTop = '1px dashed #e2e8f0';
            inputContainer.style.paddingTop = '10px';
            if (!isCustomSelected) inputContainer.style.display = 'none';

            const inputId = `${key}-custom-input`;
            const labelText = (key === 'time') ? '分' : '円';

            const input = document.createElement('input');
            input.type = 'number';
            input.id = inputId;
            input.name = `${key}-custom`;
            input.placeholder = `最大値 (${inputProps.max})`;
            input.min = inputProps.min || 1;
            input.max = inputProps.max || 9999;
            input.style.width = '120px';
            input.style.padding = '6px 10px';
            input.style.borderRadius = '6px';
            input.style.border = '1px solid #d6d8df';
            input.dataset.filterKey = key;
            input.dataset.inputType = 'custom';
            if (isCustomSelected) input.value = activeFilters[key];

            const label = document.createElement('label');
            label.htmlFor = inputId;
            label.textContent = `以下の最大値を設定 (${labelText}以下): `;
            label.style.fontWeight = 'normal';
            label.style.marginRight = '5px';

            inputContainer.appendChild(label);
            inputContainer.appendChild(input);
            fieldset.appendChild(inputContainer);
        } else {
            fieldset.appendChild(radioDiv);
        }

        return fieldset;
    }

    // ----- フィルターモーダル生成 -----
    function setupFilterModal(list){
        if (!filterContent) return;
        filterContent.innerHTML = '';
        const fragment = document.createDocumentFragment();

        // 魚種集合を収集
        const fishSet = new Set();
        list.forEach(item => {
            if (Array.isArray(item['fish-name'])){
                item['fish-name'].forEach(f => {
                    const t = String(f).trim();
                    if (t) fishSet.add(t);
                });
            }
        });
        const uniqueFish = Array.from(fishSet).sort();
        fragment.appendChild(createCheckboxGroup('魚種', 'fish-name', uniqueFish, 'レシピ/下処理に使う魚が、選択した魚種のすべてに含まれるものを表示 (b ⊆ a)'));

        fragment.appendChild(createRadioGroup('難易度 (最大)', 'difficulty', DIFFICULTY_OPTIONS, '選択した難易度以下のアイテムを表示', DIFFICULTY_OPTIONS.map(d => `難易度 ${d} 以下`)));
        fragment.appendChild(createRadioGroup('所要時間 (分・最大)', 'time', TIME_OPTIONS, '選択肢またはカスタム入力で指定した時間以下のアイテムを表示', TIME_OPTIONS.map(t => `${t}分以内`), 'radio-input', {min:1, max:TIME_MAX}));
        fragment.appendChild(createRadioGroup('費用 (円・最大)', 'cost', COST_OPTIONS, '選択肢またはカスタム入力で指定した費用以下のアイテムを表示', COST_OPTIONS.map(c => `¥${c}以下`), 'radio-input', {min:100, max:COST_MAX}));

        filterContent.appendChild(fragment);

        // イベント設定
        filterContent.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', updateActiveFilters));
        filterContent.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', handleRadioInputChange));
        filterContent.querySelectorAll('input[type="number"]').forEach(n => n.addEventListener('input', handleRadioInputChange));
    }

    function handleRadioInputChange(event){
        const input = event.target;
        const key = input.dataset.filterKey;
        if (key === 'time' || key === 'cost'){
            const container = filterContent.querySelector(`.filter-input-container input[data-filter-key="${key}"]`);
            if (container){
                const parent = container.parentNode;
                if (input.type === 'radio'){
                    if (input.value === 'CUSTOM') parent.style.display = 'block';
                    else { parent.style.display = 'none'; parent.querySelector('input[type="number"]').value = ''; }
                }
            }
        }
        updateActiveFilters();
    }

    function updateActiveFilters(){
        // fish-name
        activeFilters['fish-name'].clear();
        filterContent.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            if (cb.dataset.filterKey === 'fish-name') activeFilters['fish-name'].add(cb.value);
        });

        ['difficulty','time','cost'].forEach(key => {
            activeFilters[key] = null;
            const checkedRadio = filterContent.querySelector(`input[type="radio"][name="${key}"]:checked`);
            if (checkedRadio){
                if (checkedRadio.value === '') activeFilters[key] = null;
                else if (checkedRadio.value === 'CUSTOM'){
                    const customInput = filterContent.querySelector(`input[type="number"][data-filter-key="${key}"][data-input-type="custom"]`);
                    if (customInput){
                        const val = parseFloat(customInput.value);
                        if (!isNaN(val) && val > 0) activeFilters[key] = String(val);
                    }
                } else {
                    activeFilters[key] = checkedRadio.value;
                }
            }
        });
    }

    // ----- テーブル描画 -----
    function renderTable(list){
        clearTable();
        if (!tbody) return;
        if (!Array.isArray(list) || list.length === 0){
            tbody.innerHTML = '<tr><td colspan="8" class="muted" style="padding:20px;text-align:center">表示するレシピがありません。</td></tr>';
            return;
        }
        const fragment = document.createDocumentFragment();
        for (const item of list){
            const tr = document.createElement('tr');

            // No
            const tdNo = document.createElement('td');
            tdNo.textContent = item.No || '-';
            tr.appendChild(tdNo);

            // Type
            const tdType = document.createElement('td');
            const span = document.createElement('span');
            span.className = 'tag-type ' + (item._type === 'pre' ? 'type-pre' : 'type-recipe');
            span.textContent = item._type;
            tdType.appendChild(span);
            tr.appendChild(tdType);

            // Picture
            const tdPicture = document.createElement('td');
            const img = document.createElement('img');
            img.className = 'recipe-thumb';
            const firstPic = (Array.isArray(item.pictures) && item.pictures.length > 0) ? item.pictures[0] : null;
            let imgSrc = firstPic && typeof firstPic === 'string' ? firstPic : 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';
            img.src = imgSrc;
            img.alt = item.title || '画像';
            img.style.width = '80px';
            img.style.height = '60px';
            img.style.objectFit = 'cover';
            tdPicture.appendChild(img);
            tr.appendChild(tdPicture);

            // Title and flavortxt
            const tdTitle = document.createElement('td');
            const title = elText('div', item.title || '(タイトルなし)', ''); title.style.fontWeight='700';
            const flav = elText('div', item.flavortxt || '', 'muted');
            tdTitle.appendChild(title);
            tdTitle.appendChild(flav);
            tr.appendChild(tdTitle);

            // fish / season
            const tdFish = document.createElement('td');
            tdFish.appendChild(elText('div', joinIfArray(item['fish-name']) || '-', ''));
            tdFish.appendChild(elText('div', joinIfArray(item.season) || '', 'muted'));
            tr.appendChild(tdFish);

            // difficulty / time
            const tdDiff = document.createElement('td');
            tdDiff.appendChild(elText('div', '難易度: ' + (item.difficulty != null ? item.difficulty : '-')));
            tdDiff.appendChild(elText('div', '所要: ' + (item.time != null ? item.time + '分' : '-'), 'muted'));
            tr.appendChild(tdDiff);

            // cost / info line
            const tdCost = document.createElement('td');
            tdCost.appendChild(elText('div', '¥' + (item.cost != null ? item.cost : '-')));
            const infoLine = (item._type === 'recipe') ? ('食事: ' + (item.timing || '-')) : ('特徴: ' + joinIfArray(item.feature));
            tdCost.appendChild(elText('div', infoLine, 'muted'));
            tr.appendChild(tdCost);

            // actions
            const tdActions = document.createElement('td');
            tdActions.className = 'actions';

            const viewBtn = document.createElement('button');
            viewBtn.textContent = '詳細';
            viewBtn.addEventListener('click', ()=> displayDetail(item));
            tdActions.appendChild(viewBtn);

            const printBtn = document.createElement('button');
            printBtn.textContent = '印刷';
            printBtn.style.background = '#a0aec0';
            printBtn.addEventListener('click', ()=> {
                displayDetail(item);
                setTimeout(()=> window.print(), 500);
            });
            tdActions.appendChild(printBtn);

            tr.appendChild(tdActions);
            fragment.appendChild(tr);
        }
        tbody.appendChild(fragment);
    }

    // 画像要素作成
    function createPictureElement(src, altText, maxHeight = '250px'){
        if (!src || src === 'null' || src === '') return null;
        const img = document.createElement('img');
        img.src = src;
        img.alt = altText || '画像';
        img.style.maxWidth = '100%';
        img.style.maxHeight = maxHeight;
        img.style.width = 'auto';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '4px';
        img.style.display = 'block';
        img.style.margin = '0 auto';
        return img;
    }

    // 詳細表示
    function displayDetail(item){
        if(!detailTitle || !detailSubtitle || !detailMeta || !detailImageContainer || !detailIngredients || !detailRecipe || !detailMemo || !propsSection) {
            console.error("Missing detail element(s) in HTML.");
            return;
        }

        if (wrap) {
            wrap.classList.remove('list-view');
            wrap.classList.add('detail-view');
        }
        // show detail container, hide table
        if (detailContainer) {
            detailContainer.style.display = 'block';
            detailContainer.setAttribute('aria-hidden','false');
        }
        if (document.getElementById('recipeTable')) {
            document.getElementById('recipeTable').style.display = 'none';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });

        const pictures = item.pictures || [];
        const thumbPic = pictures[0] || 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';

        detailTitle.textContent = (item.title || '(タイトルなし)') + ' — No.' + item.No;
        detailSubtitle.textContent = item.flavortxt || '';

        detailMeta.innerHTML = '';
        detailMeta.appendChild(elText('div', 'タイプ: ' + (item._type || '-'), 'pill'));
        detailMeta.appendChild(elText('div', '魚: ' + joinIfArray(item['fish-name']) , 'pill'));
        detailMeta.appendChild(elText('div', '旬: ' + joinIfArray(item.season), 'pill'));
        detailMeta.appendChild(elText('div', '難易度: ' + (item.difficulty != null ? item.difficulty : '-'), 'pill'));
        detailMeta.appendChild(elText('div', '費用: ' + (item.cost != null ? '¥' + item.cost : '-'), 'pill'));
        detailMeta.appendChild(elText('div', '所要時間: ' + (item.time != null ? item.time + '分' : '-'), 'pill'));

        if (item._type === 'recipe') {
            const preRecipeNo = item['pre-recipe'] ? String(item['pre-recipe']) : null;
            if (preRecipeNo) {
                const preItem = flatList.find(i => i._type === 'pre' && String(i.No) === preRecipeNo);
                if (preItem) {
                    const preBtn = document.createElement('button');
                    preBtn.textContent = '下処理: ' + (preItem.title || preItem.No); 
                    preBtn.className = 'pill pre-link-pill';
                    preBtn.style.cursor = 'pointer'; 
                    preBtn.addEventListener('click', ()=> displayDetail(preItem)); 
                    detailMeta.appendChild(preBtn);
                } else {
                    detailMeta.appendChild(elText('div', '下処理: No.' + preRecipeNo + ' (未発見)', 'pill'));
                }
            } else {
                 detailMeta.appendChild(elText('div', '下処理: なし', 'pill'));
            }
        } else if (item._type === 'pre') {
             detailMeta.appendChild(elText('div', '下処理', 'pill'));
        }

        detailImageContainer.innerHTML = '';
        const mainImg = createPictureElement(thumbPic, item.title, '250px');
        if (mainImg) {
            mainImg.style.border = '1px solid #ddd';
            mainImg.style.borderRadius = '8px';
            detailImageContainer.appendChild(mainImg);
        }

        // 材料
        detailIngredients.innerHTML = '';
        const ing = item.ingredients || {};
        if (!ing || Object.keys(ing).length === 0){
            detailIngredients.appendChild(elText('div','(材料なし)','muted'));
        } else {
            const ul = document.createElement('ul');
            for (const k of Object.keys(ing)){
                const li = document.createElement('li');
                li.textContent = k + ': ' + (ing[k] || '');
                ul.appendChild(li);
            }
            detailIngredients.appendChild(ul);
        }

        // 道具（pre のみ表示）
        detailProps.innerHTML = '';
        const props = item.props || {};
        if (item._type === 'pre') {
            if (propsSection) propsSection.style.display = 'block';
            if (!props || Object.keys(props).length === 0){
                detailProps.appendChild(elText('div', '(道具なし)', 'muted'));
            } else {
                const ul = document.createElement('ul');
                for (const k of Object.keys(props)){
                    const li = document.createElement('li');
                    li.textContent = props[k] || '';
                    ul.appendChild(li);
                }
                detailProps.appendChild(ul);
            }
        } else {
            if (propsSection) propsSection.style.display = 'none';
        }

        // レシピ手順
        detailRecipe.innerHTML = '';
        const rec = item.recipe || [];
        if (!Array.isArray(rec) || rec.length === 0){
            detailRecipe.appendChild(elText('div','(手順なし)','muted'));
        } else {
            const gridContainer = document.createElement('div');
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
            gridContainer.style.gap = '10px';
            for (let i = 0; i < rec.length; i++){
                const step = rec[i];
                const stepNo = i + 1;
                const card = document.createElement('div');
                card.className = 'recipe-step-card';
                card.style.border = '1px solid #dee2e6';
                card.style.padding = '15px';
                card.style.borderRadius = '6px';
                card.style.background = 'var(--card)';
                card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
                const stepPicIndex = i + 1;
                const stepPicSrc = (item.pictures && item.pictures[stepPicIndex]) ? item.pictures[stepPicIndex] : null;
                if (stepPicSrc && stepPicSrc !== 'null' && stepPicSrc !== '') {
                    const picContainer = document.createElement('div');
                    picContainer.className = 'recipe-step-picture';
                    const stepImg = createPictureElement(stepPicSrc, `手順${stepNo}の画像`, '150px');
                    if (stepImg) {
                        picContainer.appendChild(stepImg);
                        card.appendChild(picContainer);
                    }
                }
                const p = document.createElement('p');
                p.innerHTML = `<span style="font-weight:bold; color:var(--accent);">${stepNo}.</span> ${step}`;
                card.appendChild(p);
                gridContainer.appendChild(card);
            }
            detailRecipe.appendChild(gridContainer);
        }

        // メモ
        detailMemo.innerHTML = '';
        const memo = item.memo || [];
        if (!Array.isArray(memo) || memo.length === 0){
            detailMemo.appendChild(elText('div','(メモなし)','muted'));
        } else {
            const ulm = document.createElement('ul');
            for (const m of memo){
                const li = document.createElement('li');
                li.textContent = m;
                ulm.appendChild(li);
            }
            detailMemo.appendChild(ulm);
        }
    }

    // ----- フィルター適用と描画 -----
    function applyFiltersAndRender(){
        if(!qInput || !filterType || !sortBy || !message) { return; }

        const q = (qInput.value || '').trim().toLowerCase();
        const type = filterType.value;
        const sortVal = sortBy.value;

        let list = flatList.slice();

        // type filter
        if (type !== 'all') list = list.filter(i => i._type === type);

        // search
        if (q){
            list = list.filter(item => {
                const parts = [
                    item.title, item.flavortxt,
                    joinIfArray(item['fish-name']),
                    joinIfArray(item.feature),
                    joinIfArray(item.season),
                    item.No,
                    Object.keys(item.ingredients || {}).join(' '),
                    joinIfArray(item.recipe),
                    joinIfArray(item.memo),
                    joinIfArray(item.props)
                ];
                const hay = parts.filter(Boolean).join(' ').toLowerCase();
                return hay.includes(q);
            });
        }

        // filter logic (applies to both recipe and pre)
        list = list.filter(item => {
            // fish-name: activeFilters['fish-name'] is a Set (a)
            const activeFish = activeFilters['fish-name'];
            if (activeFish.size > 0){
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => String(f).trim()) : [];
                // check: itemFish (b) are all included in activeFish (a): b ⊆ a
                const allMatch = itemFish.every(f => activeFish.has(f));
                if (!allMatch) return false;
            }

            // difficulty
            const maxDiff = activeFilters.difficulty ? parseFloat(activeFilters.difficulty) : null;
            if (maxDiff !== null && item.difficulty != null){
                const itemDiff = parseFloat(item.difficulty);
                if (!isNaN(itemDiff) && itemDiff > maxDiff) return false;
            }

            // time
            const maxTime = activeFilters.time ? parseFloat(activeFilters.time) : null;
            if (maxTime !== null && item.time != null){
                const itemTime = parseFloat(item.time);
                if (!isNaN(itemTime) && itemTime > maxTime) return false;
            }

            // cost
            const maxCost = activeFilters.cost ? parseFloat(activeFilters.cost) : null;
            if (maxCost !== null && item.cost != null){
                const itemCost = parseFloat(item.cost);
                if (!isNaN(itemCost) && itemCost > maxCost) return false;
            }

            return true;
        });

        // sort
        const desc = sortVal.startsWith('-');
        const key = desc ? sortVal.slice(1) : sortVal;
        list.sort((a,b) => {
            const av = a[key];
            const bv = b[key];
            if (key === 'No'){
                const extractNum = (val) => {
                    const s = String(val||'');
                    const isPre = s.startsWith('P');
                    const num = parseInt(s.replace(/^P/,'') || '0', 10);
                    return isPre ? num + 0.5 : num;
                };
                const na = extractNum(av);
                const nb = extractNum(bv);
                return desc ? nb - na : na - nb;
            }
            const an = (av == null) ? Number.POSITIVE_INFINITY : Number(av);
            const bn = (bv == null) ? Number.POSITIVE_INFINITY : Number(bv);
            if (!isFinite(an) || !isFinite(bn)){
                return desc ? String(bv).localeCompare(String(av)) : String(av).localeCompare(String(bv));
            }
            return desc ? bn - an : an - bn;
        });

        renderTable(list);

        let activeCount = activeFilters['fish-name'].size;
        ['difficulty','time','cost'].forEach(k => { if (activeFilters[k] !== null) activeCount++; });

        let filterText = '';
        if (activeCount > 0) filterText = ` (${activeCount} 種類のフィルター適用中)`;
        message.textContent = `${list.length} 件の結果を表示中 (全 ${flatList.length} 件)${filterText}`;
    }

    // ----- モーダル / UI 操作 -----
    // filter modal open/close
    if (filterOpenBtn && filterModal){
        filterOpenBtn.addEventListener('click', ()=> {
            if (filterModal){
                filterModal.style.display = 'flex';
                filterModal.setAttribute('aria-hidden','false');
            }
        });
    }
    // apply and close
    if (applyFilterBtn){
        applyFilterBtn.addEventListener('click', ()=> {
            updateActiveFilters();
            if (filterModal){
                filterModal.style.display = 'none';
                filterModal.setAttribute('aria-hidden','true');
            }
            applyFiltersAndRender();
        });
    }
    // clear filters
    if (filterClearBtn){
        filterClearBtn.addEventListener('click', ()=> {
            // reset activeFilters
            activeFilters['fish-name'].clear();
            activeFilters.difficulty = null;
            activeFilters.time = null;
            activeFilters.cost = null;
            // rebuild UI
            setupFilterModal(flatList);
            applyFiltersAndRender();
        });
    }
    // close modal when clicking outside content
    if (filterModal){
        filterModal.addEventListener('click', (e) => {
            if (e.target === filterModal){
                filterModal.style.display = 'none';
                filterModal.setAttribute('aria-hidden','true');
            }
        });
    }
    // esc to close modals
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape'){
            if (filterModal && filterModal.style.display === 'flex'){ filterModal.style.display = 'none'; filterModal.setAttribute('aria-hidden','true'); }
            if (proposeModal && proposeModal.style.display === 'flex'){ proposeModal.style.display = 'none'; }
            if (proposalModal && proposalModal.style.display === 'block'){ proposalModal.style.display = 'none'; }
        }
    });

    // back to list
    if (backToListBtn){
        backToListBtn.addEventListener('click', ()=> {
            if (wrap) {
                wrap.classList.remove('detail-view');
                wrap.classList.add('list-view');
            }
            if (detailContainer) {
                detailContainer.style.display = 'none';
                detailContainer.setAttribute('aria-hidden','true');
            }
            if (document.getElementById('recipeTable')) {
                document.getElementById('recipeTable').style.display = 'table';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // ----- リロード -----
    if (reloadBtn){
        reloadBtn.addEventListener('click', ()=> {
            loadData();
        });
    }

    // ----- 検索・ソート・タイプ 反応 -----
    if (qInput){
        qInput.addEventListener('input', ()=> {
            applyFiltersAndRender();
        });
    }
    if (filterType){
        filterType.addEventListener('change', ()=> applyFiltersAndRender());
    }
    if (sortBy){
        sortBy.addEventListener('change', ()=> applyFiltersAndRender());
    }

    // ----- レシピ提案モーダル挙動 -----
    if (proposeOpenBtn && proposeModal){
        proposeOpenBtn.addEventListener('click', ()=> {
            // build include/exclude fish checkboxes (from current flatList)
            buildFishCheckboxesForPropose(flatList);
            proposeModal.style.display = 'flex';
            proposeModal.setAttribute('aria-hidden','false');
            // initial preview
            updateProposalPreview();
        });
    }
    if (closeProposeBtn){
        closeProposeBtn.addEventListener('click', ()=> {
            if (proposeModal) { proposeModal.style.display = 'none'; proposeModal.setAttribute('aria-hidden','true'); }
        });
    }
    if (proposeModal){
        proposeModal.addEventListener('click', (e) => {
            if (e.target === proposeModal){ proposeModal.style.display = 'none'; proposeModal.setAttribute('aria-hidden','true'); }
        });
    }

    // include/exclude mode toggles
    document.querySelectorAll('input[name="includeFishMode"]').forEach(r => {
        r.addEventListener('change', (e) => {
            if (e.target.value === 'specify') includeFishRow.style.display = 'block';
            else includeFishRow.style.display = 'none';
        });
    });
    document.querySelectorAll('input[name="excludeFishMode"]').forEach(r => {
        r.addEventListener('change', (e) => {
            if (e.target.value === 'specify') excludeFishRow.style.display = 'block';
            else excludeFishRow.style.display = 'none';
        });
    });

    // meals/custom handling
    document.querySelectorAll('input[name="meals"]').forEach(r => {
        r.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                customMealRow.style.display = 'flex';
                counterContainer.style.display = 'none';
            } else {
                customMealRow.style.display = 'none';
                counterContainer.style.display = 'none';
                counterValue.textContent = e.target.value;
            }
        });
    });
    if (customMealConfirm){
        customMealConfirm.addEventListener('click', ()=> {
            const v = parseInt(customMealInput.value, 10);
            if (!isNaN(v) && v >= 1){
                counterValue.textContent = String(v);
                customMealRow.style.display = 'none';
            }
        });
    }
    if (leftBtn && rightBtn){
        leftBtn.addEventListener('click', ()=> {
            let v = parseInt(counterValue.textContent || '1', 10);
            if (isNaN(v)) v = 1;
            if (v > 1) v--;
            counterValue.textContent = String(v);
        });
        rightBtn.addEventListener('click', ()=> {
            let v = parseInt(counterValue.textContent || '1', 10);
            if (isNaN(v)) v = 1;
            v++;
            counterValue.textContent = String(v);
        });
    }

    // propose generate -> produce simple proposal list based on constraints
    if (proposeGenerateBtn){
        proposeGenerateBtn.addEventListener('click', ()=> {
            const proposals = generateProposals();
            showProposalResults(proposals);
            // show proposal modal
            if (proposalModal) proposalModal.style.display = 'block';
            if (proposeModal) proposeModal.style.display = 'none';
        });
    }

    if (backToSettingsBtn){
        backToSettingsBtn.addEventListener('click', ()=> {
            if (proposalModal) proposalModal.style.display = 'none';
            if (proposeModal) proposeModal.style.display = 'flex';
        });
    }
    if (closeProposalBtn){
        closeProposalBtn.addEventListener('click', ()=> {
            if (proposalModal) proposalModal.style.display = 'none';
        });
    }

    // ----- プロポーザル 補助関数 -----
    function buildFishCheckboxesForPropose(list){
        // collect unique fish
        const fishSet = new Set();
        list.forEach(item => {
            if (Array.isArray(item['fish-name'])){
                item['fish-name'].forEach(f => {
                    const t = String(f).trim();
                    if (t) fishSet.add(t);
                });
            }
        });
        const uniqueFish = Array.from(fishSet).sort();
        // clear containers
        includeFishContainer.innerHTML = '';
        excludeFishContainer.innerHTML = '';
        uniqueFish.forEach((f, idx) => {
            const id1 = `propose-include-${idx}-${f.replace(/[^0-9a-zA-Z]/g,'')}`;
            const cb1 = document.createElement('input');
            cb1.type = 'checkbox';
            cb1.id = id1;
            cb1.value = f;
            cb1.name = 'proposeIncludeFish';
            const label1 = document.createElement('label');
            label1.htmlFor = id1;
            label1.style.marginRight = '10px';
            label1.appendChild(document.createTextNode(f));
            includeFishContainer.appendChild(cb1);
            includeFishContainer.appendChild(label1);

            const id2 = `propose-exclude-${idx}-${f.replace(/[^0-9a-zA-Z]/g,'')}`;
            const cb2 = document.createElement('input');
            cb2.type = 'checkbox';
            cb2.id = id2;
            cb2.value = f;
            cb2.name = 'proposeExcludeFish';
            const label2 = document.createElement('label');
            label2.htmlFor = id2;
            label2.style.marginRight = '10px';
            label2.appendChild(document.createTextNode(f));
            excludeFishContainer.appendChild(cb2);
            excludeFishContainer.appendChild(label2);
        });
    }

    function updateProposalPreview(){
        // simple preview showing counts that would match current filter selections in propose modal
        const proposals = generateProposals({preview:true});
        proposalPreview.innerHTML = '';
        const div = document.createElement('div');
        div.textContent = `候補: ${proposals.length} 件 (プレビュー)`;
        proposalPreview.appendChild(div);
        // show top 3 titles
        proposals.slice(0,3).forEach(p => {
            const d = document.createElement('div');
            d.style.padding = '6px 0';
            d.textContent = `${p.No} — ${p.title || '(タイトルなし)'}`;
            proposalPreview.appendChild(d);
        });
    }

    function generateProposals(opts = {}){
        // read propose modal form values and filter flatList accordingly
        const mode = (document.querySelector('input[name="mode"]:checked') || {value:'all'}).value;
        const mealsSel = (document.querySelector('input[name="meals"]:checked') || {value:'1'}).value;
        let meals = 1;
        if (mealsSel === 'custom'){
            const v = parseInt(customMealInput.value, 10);
            meals = (!isNaN(v) && v >= 1) ? v : 1;
        } else {
            meals = parseInt(mealsSel, 10) || 1;
        }

        // include/exclude fish
        const includeMode = (document.querySelector('input[name="includeFishMode"]:checked') || {value:'none'}).value;
        const excludeMode = (document.querySelector('input[name="excludeFishMode"]:checked') || {value:'none'}).value;
        const includeFish = includeMode === 'specify' ? Array.from(document.querySelectorAll('input[name="proposeIncludeFish"]:checked')).map(i => i.value) : [];
        const excludeFish = excludeMode === 'specify' ? Array.from(document.querySelectorAll('input[name="proposeExcludeFish"]:checked')).map(i => i.value) : [];

        // difficulty/time/cost from propose modal (note: propose modal inputs share names with filter modal, but we query directly)
        const diffRadio = document.querySelector('input[name="difficulty"]:checked');
        const difficulty = diffRadio ? diffRadio.value : '';

        const timeRadio = document.querySelector('input[name="time"]:checked');
        let timeVal = timeRadio ? timeRadio.value : '';
        if (timeVal === 'custom'){
            const ti = document.getElementById('customTimeInput');
            if (ti) timeVal = ti.value || '';
        }

        const costRadio = document.querySelector('input[name="cost"]:checked');
        let costVal = costRadio ? costRadio.value : '';
        if (costVal === 'custom'){
            const ci = document.getElementById('customCostInput');
            if (ci) costVal = ci.value || '';
        }

        // filter flatList: prefer recipes (exclude pre) for proposals
        let candidates = flatList.filter(i => i._type === 'recipe');

        if (includeFish.length > 0){
            // require recipe's fish set to include at least one of includeFish (OR semantics for propose)
            candidates = candidates.filter(item => {
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => f.trim()) : [];
                // include if any of includeFish in itemFish
                return includeFish.some(f => itemFish.includes(f));
            });
        }
        if (excludeFish.length > 0){
            candidates = candidates.filter(item => {
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => f.trim()) : [];
                return !excludeFish.some(f => itemFish.includes(f));
            });
        }

        if (difficulty && difficulty !== ''){
            const maxD = parseFloat(difficulty);
            if (!isNaN(maxD)) candidates = candidates.filter(i => i.difficulty == null ? true : (parseFloat(i.difficulty) <= maxD));
        }
        if (timeVal && timeVal !== ''){
            const maxT = parseFloat(timeVal);
            if (!isNaN(maxT)) candidates = candidates.filter(i => i.time == null ? true : (parseFloat(i.time) <= maxT));
        }
        if (costVal && costVal !== ''){
            const maxC = parseFloat(costVal);
            if (!isNaN(maxC)) candidates = candidates.filter(i => i.cost == null ? true : (parseFloat(i.cost) <= maxC));
        }

        // dedupe and sort by No ascending
        candidates.sort((a,b) => {
            const na = parseFloat(String(a.No).replace(/^P/,'') || '0');
            const nb = parseFloat(String(b.No).replace(/^P/,'') || '0');
            return na - nb;
        });

        // propose: pick top N recipes where N == meals (but cap to 50)
        const N = Math.min(Math.max(1, meals), 50);
        const proposals = candidates.slice(0, N);

        // preview mode returns full array; otherwise return proposals
        if (opts.preview) return proposals;
        return proposals;
    }

    function showProposalResults(list){
        if (!proposalResults) return;
        proposalResults.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0){
            proposalResults.innerHTML = '<div class="muted">該当する提案がありませんでした。</div>';
            return;
        }
        const ul = document.createElement('ul');
        list.forEach(item => {
            const li = document.createElement('li');
            li.style.marginBottom = '8px';
            const title = item.title || '(タイトルなし)';
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = `${item.No} — ${title}`;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                // close proposal modal, open detail
                if (proposalModal) proposalModal.style.display = 'none';
                displayDetail(item);
            });
            li.appendChild(a);
            ul.appendChild(li);
        });
        proposalResults.appendChild(ul);
    }

    // ----- 初期化 / データ読み込み -----
    async function loadData(){
        // show loading
        if (message) message.textContent = 'データを読み込み中です...';
        try {
            rawData = await fetchAny(tryPaths);
            flatList = buildFlatList(rawData);
            // default view class
            if (wrap){
                wrap.classList.add('list-view');
                wrap.classList.remove('detail-view');
            }
            // prepare filter modal UI
            setupFilterModal(flatList);
            // initial render
            applyFiltersAndRender();
            // update propose preview if modal exists
            if (proposalPreview) updateProposalPreview();
        } catch (e){
            console.error(e);
            if (message) message.textContent = 'データの読み込みに失敗しました。recipes.json を配置してください。';
            flatList = [];
            renderTable([]);
        }
    }

    // ----- 起動時処理 -----
    // set sensible defaults
    (function boot(){
        // small defensive defaults
        if (!wrap) console.warn('wrap not found');
        // load data
        loadData();

        // update preview when propose controls change
        document.querySelectorAll('#proposeModal input').forEach(inp => {
            inp.addEventListener('change', updateProposalPreview);
            inp.addEventListener('input', updateProposalPreview);
        });

        // also update preview when include/exclude checkboxes are clicked (they are built on open)
        // attach a small interval to refresh preview if proposeModal opened later and controls are added
        setInterval(() => {
            if (proposeModal && proposeModal.style.display === 'flex') {
                // attach listeners once for any newly added checkboxes
                document.querySelectorAll('input[name="proposeIncludeFish"], input[name="proposeExcludeFish"]').forEach(cb => {
                    if (!cb.dataset._listenerAttached){
                        cb.addEventListener('change', updateProposalPreview);
                        cb.dataset._listenerAttached = '1';
                    }
                });
            }
        }, 500);
    })();

})(); 
</script>
</body>
</html>
