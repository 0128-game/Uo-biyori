<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é­šæ–™ç†ãƒ¬ã‚·ãƒ”ä¸€è¦§</title>
<style>
/* ----------------------------------------------------- */
/* 0. å¤‰æ•°ã¨ãƒªã‚»ãƒƒãƒˆ */
    
/* ----------------------------------------------------- */
:root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#2b6cb0;
    --muted:#666;
    --success:#2f855a;
    --danger:#c53030;
    --max-width:1400px; /* wrapã«åˆã‚ã›ã‚‹ãŸã‚1400pxã«ä¿®æ­£ */
    --shadow:0 6px 18px rgba(20,20,40,0.08); /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¨åŒã˜å½± */
}
*{box-sizing:border-box}
body{
    font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo",sans-serif;
    margin:0;
    background:var(--bg);
    color:#222;
    padding:20px;
    display:flex;
    justify-content:center;
}
.wrap{
    width:100%;
    max-width:var(--max-width);
}
/* ----------------------------------------------------- */
/* 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
/* ----------------------------------------------------- */
header{
    /* headerè‡ªä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¯å…ƒã®CSSã¨åˆã‚ã›ã‚‹ */
    background:var(--card);
    padding:15px 25px;
    border-radius:10px; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¨åˆã‚ã›ã‚‹ */
    box-shadow:0 4px 12px rgba(20,20,40,0.05); /* å½±ã‚’è¿½åŠ  */
    margin-bottom:20px;
    
    display:flex;
    gap:12px;
    align-items:flex-end;
}
header h1{margin:0;font-size:1.6rem; color:var(--accent);}
.controls{
    margin-left:auto;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
}
input[type="search"], select{
    padding:9px 12px; /* å°‘ã—å¤§ãã */
    border-radius:8px;
    border:1px solid #d6d8df;
    background:white;
}
button{
    padding:9px 14px; /* å°‘ã—å¤§ãã */
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    transition:background-color 0.2s;
}
button:hover:not(:disabled){
    background: #23548f; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚ˆã‚Šå°‘ã—æ¿ƒã */
}
button:disabled{opacity:.6;cursor:not-allowed}

/* ----------------------------------------------------- */
/* 2. ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º */
/* ----------------------------------------------------- */
main{
    background:transparent;
}
#message{
    padding:10px 0;
    font-size:0.95rem;
}
table{
    width:100%;
    border-collapse:separate; /* è§’ä¸¸ã®ãŸã‚ã«separateã«å¤‰æ›´ */
    border-spacing: 0;
    background:var(--card);
    border-radius:10px;
    overflow:hidden;
    box-shadow:var(--shadow);
}
thead th{
    text-align:left;
    padding:12px 14px;
    font-size:0.9rem;
    background:#f1f5f9;
    border-bottom:1px solid #e2e8f0; /* å°‘ã—æ¿ƒã„ç·š */
    font-weight:600;
}
tbody td{
    padding:12px 14px;
    border-bottom:1px dashed #e2e8f0; /* dashedç·šã‚’æ¡ç”¨ */
    vertical-align:top;
    font-size:0.95rem;
}
tbody tr:hover{background:rgba(43,108,176,0.03)}

.muted{color:var(--muted);font-size:0.85rem}

.recipe-thumb{
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    display: block;
}

/* ã‚¿ã‚¤ãƒ—ã‚¿ã‚°ã®è‰²ã‚’å…ƒã®CSSã®é›°å›²æ°—ã«åˆã‚ã›ã‚‹ */
.tag-type{padding:4px 8px;border-radius:6px;font-size:0.8rem; font-weight: 500;}
.type-recipe{background:#fff7ed;color:#b45309;border:1px solid #f6e7d0}
.type-pre{background:#f0fff4;color:var(--success);border:1px solid #d6f7df}

.actions button{
    margin-right:6px;
    padding: 6px 10px;
    font-size: 0.9rem;
    margin-bottom: 4px;
}
/* è©³ç´°ãƒœã‚¿ãƒ³ï¼ˆé’ï¼‰ */
.actions button:first-child{
    background:var(--accent);
}
/* å°åˆ·ãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
.actions button:nth-child(2){
    background:#a0aec0; 
}


/* ----------------------------------------------------- */
/* 3. è©³ç´°ãƒ“ãƒ¥ãƒ¼ */
/* ----------------------------------------------------- */
.detail-container{
    padding: 25px;
    background: var(--card);
    border-radius: 10px;
    box-shadow: var(--shadow);
}

/* ãƒ“ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ (JSã‚¯ãƒ©ã‚¹) */
.list-view #recipeTable { display: table; }
.list-view #detailContainer { display: none; }
.detail-view #recipeTable { display: none; }
.detail-view #detailContainer { display: block; }

.detail-header {
    padding-bottom: 15px;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 20px;
    position: relative;
}

.back-button {
    background: #909090 !important; /* ç›®ç«‹ã¡ã™ããªã„ã‚°ãƒ¬ãƒ¼ */
    color: white;
    padding: 8px 15px;
    border-radius: 4px;
    font-size: 1em;
    position: absolute;
    top: 0;
    right: 0;
}

.detail-header h2 {
    font-size: 1.5rem;
    color: #343a40;
    margin-top: 0;
    margin-bottom: 5px;
    padding-right: 150px; 
}

/* ãƒ¡ã‚¿æƒ…å ± (pill) */
.meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.pill{
    display:inline-block;
    padding:4px 10px; /* å°‘ã—å¤§ãã */
    border-radius:999px;
    background:#eef5ff;
    color:var(--accent);
    font-size:0.85rem;
    font-weight: 500;
}

.pre-link-pill {
    background: #17a2b8 !important; /* ä¸‹å‡¦ç†ãƒªãƒ³ã‚¯ã¯ç›®ç«‹ã¤è‰² */
    color: white !important;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚°ãƒªãƒƒãƒ‰ */
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.detail-section {
    padding: 15px;
    border: 1px solid #eef2f7;
    border-radius: 8px;
    background: var(--f8f9fa); /* ã‚„ã‚„è–„ã„èƒŒæ™¯ */
}

.section-title {
    font-size: 1.2rem;
    color: var(--accent);
    border-bottom: 2px solid var(--accent);
    padding-bottom: 5px;
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: 600;
}

#detailIngredients ul, 
#detailMemo ul, 
#detailProps ul {
    list-style: disc;
    padding-left: 20px;
    margin-top: 0;
    line-height: 1.6;
}

/* ãƒ¬ã‚·ãƒ”æ‰‹é †ã®ã‚«ãƒ¼ãƒ‰ */
.recipe-step-card {
    border: 1px solid #eef2f7;
    padding: 15px;
    border-radius: 6px;
    background: var(--card);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    line-height: 1.6;
}

.recipe-step-card img {
    border-radius: 4px;
    margin-bottom: 10px;
}

/* ----------------------------------------------------- */
/* 4. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI) - ã‚¯ãƒ©ã‚¹åã‚’ modal-overlay ã«çµ±ä¸€ */
/* ----------------------------------------------------- */
#filterModal { /* IDã§æŒ‡å®š */
    position:fixed;
    inset:0;
    background:rgba(12,18,30,0.45);
    display:none; /* JSã§ 'flex' ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ */
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:1000;
}

.modal-content {
    width:100%;
    max-width:760px;
    background:var(--card);
    border-radius:12px;
    padding:25px; /* å°‘ã—å¤§ãã */
    box-shadow:0 10px 30px rgba(10,20,40,0.25);
    max-height:90vh;
    overflow:auto;
}

.modal-content h2 {
    font-size:1.5rem;
    color:var(--accent);
    border-bottom:2px solid var(--accent);
    padding-bottom:8px;
    margin:0 0 20px 0;
}

.filter-group {
    border: 1px solid #e2e8f0;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    background-color: #fcfdfe;
}

.filter-group legend {
    font-weight: 700;
    padding: 0 10px;
    color: #343a40;
    font-size: 1.1em;
}

.filter-hint {
    font-size: 0.85em;
    color: var(--muted);
    margin: 5px 0 10px 0;
}

.filter-item {
    display: inline-block;
    margin-right: 25px;
    margin-bottom: 8px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
    margin-top: 10px;
}

.modal-footer button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1em;
}

#filterClearBtn {
    background: #a0aec0; /* å°åˆ·ãƒœã‚¿ãƒ³ã¨åŒã˜ã‚°ãƒ¬ãƒ¼ */
    color: white;
}

#applyFilterBtn {
    background: var(--accent);
    color: white;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width:768px){
    .controls {
        justify-content: space-between;
    }
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    .detail-grid {
        grid-template-columns: 1fr;
    }
    .back-button {
        position: static;
        margin-top: 10px;
        float: none;
        display: block;
        width: 100%;
        text-align: center;
    }
    .detail-header h2 {
        padding-right: 0;
    }
}
/* --------------------------------------------------
   ãƒ¬ã‚·ãƒ”ææ¡ˆãƒœã‚¿ãƒ³
   -------------------------------------------------- */
#proposeOpenBtn {
  background: #38b2ac;
  color: #fff;
  font-weight: bold;
  border-radius: 8px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s;
}
#proposeOpenBtn:hover { background: #2c7a7b; }

/* --------------------------------------------------
   ãƒ¬ã‚·ãƒ”ææ¡ˆãƒœã‚¿ãƒ³
   -------------------------------------------------- */
#proposeOpenBtn {
  background: #38b2ac;
  color: #fff;
  font-weight: bold;
  border-radius: 8px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s;
}
#proposeOpenBtn:hover { background: #2c7a7b; }

/* --------------------------------------------------
   ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
   -------------------------------------------------- */
#proposeModal {
  display: none; /* â† åˆæœŸã¯éè¡¨ç¤º */
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 30px;
}

/* --------------------------------------------------
   ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“
   -------------------------------------------------- */
.modal-content {
  background: #fff;
  border-radius: 14px;
  width: 96%;
  max-width: 1400px;
  max-height: 92vh;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: row; /* å·¦å³ä¸¦åˆ— */
  justify-content: space-between;
  gap: 24px;
  overflow: hidden;
  padding: 0;
  position: relative;
}

/* --------------------------------------------------
   å·¦å´ï¼ˆæ¡ä»¶ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼‰
   -------------------------------------------------- */
.modal-left {
  flex: 2;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  max-height: 92vh;
  padding: 24px 20px 24px 24px;
  border-right: 1px solid #ddd;
  box-sizing: border-box;
  background: #fff;
}

/* --------------------------------------------------
   å³å´ï¼ˆã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ«ï¼‰
   -------------------------------------------------- */
#summaryPanel {
  flex: 1;
  background: #f9fafc;
  border-left: 2px solid #ddd;
  padding: 24px 20px;
  border-radius: 0 14px 14px 0;
  height: 92vh;
  overflow-y: auto;
  box-sizing: border-box;
}

#summaryPanel h3 {
  text-align: center;
  margin-bottom: 16px;
  font-size: 1.3rem;
  font-weight: bold;
}

/* --- è¤‡æ•°é£Ÿæ™‚ã‚«ãƒ¼ãƒ‰å½¢å¼ --- */
.summary-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.06);
}
.summary-card.active {
  border-color: #2b6cb0;
  background: #eaf4ff;
}

/* --- 1é£Ÿæ™‚ã¯å¤§ããè¡¨ç¤º --- */
.summary-single {
  background: #fff;
  border: 2px solid #3182ce;
  border-radius: 12px;
  padding: 20px;
  font-size: 1.1rem;
  line-height: 1.6;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  color: #2d3748;
}
.summary-single h4 {
  font-size: 1.4rem;
  color: #2b6cb0;
  text-align: center;
  margin-bottom: 10px;
}

/* --------------------------------------------------
   å…±é€šUI
   -------------------------------------------------- */
.propose-group {
  margin-bottom: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 15px;
  background: #fafcff;
}
.counter {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}
.counter button {
  background: var(--accent, #2b6cb0);
  color:white;
  border:none;
  border-radius:6px;
  font-size:1.2rem;
  width:35px;
  height:35px;
  cursor:pointer;
}
.counter span {
  font-size:1.4rem;
  font-weight:bold;
  min-width:40px;
  text-align:center;
  display:inline-block;
}
.close-propose {
  position: absolute;
  top: 12px;
  right: 18px;
  background:none;
  border:none;
  color:#666;
  font-size:1.8rem;
  cursor:pointer;
}

/* --------------------------------------------------
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   -------------------------------------------------- */
@media (max-width: 900px) {
  .modal-content {
    flex-direction: column;
    padding: 16px;
    width: 100%;
    max-width: 720px;
  }
  .modal-left {
    border-right: none;
    max-height: 60vh;
  }
  #summaryPanel {
    border-left: none;
    border-top: 2px solid #ddd;
    border-radius: 0 0 14px 14px;
    height: auto;
    max-height: 40vh;
  }
}

/* --------------------------------------------------
   å…¥åŠ›è£œåŠ©
   -------------------------------------------------- */
input[type="number"] { width: 80px; }
label { display: inline-flex; align-items:center; gap:8px; margin-right:8px; }

</style>

<div class="wrap" id="wrap">
    <header>
        <h1>é­šã®ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ</h1>
       <div class="controls">
            <input type="search" id="q" placeholder="ã‚¿ã‚¤ãƒˆãƒ«, ææ–™, é­šåãªã©ã§æ¤œç´¢">
            
            <select id="filterType">
                <option value="all">å…¨ã¦</option>
                <option value="recipe">ãƒ¬ã‚·ãƒ”</option>
                <option value="pre">ä¸‹å‡¦ç†</option>
            </select>
            
            <button id="filterOpenBtn">çµã‚Šè¾¼ã¿è¨­å®š</button> 
           <button id="proposeOpenBtn">ãƒ¬ã‚·ãƒ”ææ¡ˆ</button>
            
            <select id="sortBy">
                <option value="No" selected>Noé † (æ˜‡é †)</option>
                <option value="-No">Noé † (é™é †)</option>
                <option value="-difficulty">é›£æ˜“åº¦ (é«˜é †)</option>
                <option value="difficulty">é›£æ˜“åº¦ (ä½é †)</option>
                <option value="-cost">è²»ç”¨ (é«˜é †)</option>
                <option value="cost">è²»ç”¨ (ä½é †)</option>
                <option value="-time">æ™‚é–“ (é•·é †)</option>
                <option value="time">æ™‚é–“ (çŸ­é †)</option>
                <option value="title">ã‚¿ã‚¤ãƒˆãƒ«</option>
            </select>
            <button id="reloadBtn">ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿</button>
        </div>
    </header>

    <main id="app">
        <p id="message" class="muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        
        <table id="recipeTable">
            <thead>
                <tr>
                    <th style="width:80px">No</th>
                    <th style="width:80px">Type</th>
                    <th style="width:80px">Picture</th> 
                    <th>Title / flavortxt</th>
                    <th style="width:160px">é­š / æ—¬</th>
                    <th style="width:120px">é›£æ˜“åº¦ / æ™‚é–“</th>
                    <th style="width:120px">è²»ç”¨ / ãã®ä»–æƒ…å ±</th>
                    <th style="width:110px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbody">
                </tbody>
        </table>

        <div id="detailContainer" class="detail-container hidden">
            <div class="detail-header">
                <button id="backToListBtn" class="back-button">â† ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button>
                <h2 id="detailTitle"></h2>
                <div id="detailSubtitle" class="muted"></div>
                <div id="detailImageContainer" style="text-align: center; margin-bottom: 15px;"></div>
                <div id="detailMeta" class="meta"></div>
            </div>
            
            <div class="detail-grid">
                <div class="detail-section">
                    <h3 class="section-title">ææ–™ (Ingredients)</h3>
                    <div id="detailIngredients"></div>
                </div>
                <div class="detail-section" id="propsSection">
                    <h3 class="section-title">é“å…· (Props)</h3>
                    <div id="detailProps"></div>
                </div>
                <div class="detail-section">
                    <h3 class="section-title">ä¸‹å‡¦ç†ãƒ»èª¿ç†æ³• (Recipe / Pre-Process)</h3>
                    <div id="detailRecipe"></div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3 class="section-title">ãƒ¡ãƒ¢ (Memo)</h3>
                <div id="detailMemo"></div>
            </div>
        </div>
    </main>
</div>

<div id="filterModal" class="modal-overlay">
    <div class="modal-content">
        <h2>çµã‚Šè¾¼ã¿è¨­å®š</h2>
        <div id="filterContent">
            </div>
        <div class="modal-footer">
            <button id="filterClearBtn">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤</button>
            <button id="applyFilterBtn" class="primary-button">é©ç”¨ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>
<!-- â–¼è¿½åŠ ï¼šãƒ¬ã‚·ãƒ”ææ¡ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="proposeModal" style="display:none;">
  <div class="modal-content">
    <button class="close-propose" id="closeProposeBtn">&times;</button>
    <h2>ãƒ¬ã‚·ãƒ”ææ¡ˆ</h2>
      <!-- é£Ÿæ•°é¸æŠ -->
      <fieldset class="propose-group">
        <legend>é£Ÿæ•°é¸æŠ</legend>
        <label><input type="radio" name="meals" value="1" checked> 1é£Ÿ</label>
        <label><input type="radio" name="meals" value="3"> 1æ—¥(3é£Ÿ)</label>
        <label><input type="radio" name="meals" value="9"> 3æ—¥(9é£Ÿ)</label>
        <label><input type="radio" name="meals" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
        <div id="customMealInputContainer" style="margin-top:10px;display:none;">
          <input type="number" id="customMealInput" placeholder="é£Ÿæ•°ã‚’å…¥åŠ›" min="1" max="99">
          <button id="customMealConfirmBtn">æ±ºå®š</button>
        </div>
      </fieldset>

      <!-- è¨­å®šæ–¹æ³•é¸æŠ -->
      <fieldset class="propose-group" id="modeSection">
        <legend>è¨­å®šæ–¹æ³•é¸æŠ</legend>
        <label><input type="radio" name="mode" value="all" checked> ä¸€æ–‰è¨­å®š</label>
        <label><input type="radio" name="mode" value="each"> å€‹åˆ¥è¨­å®š</label>
      </fieldset>

      <!-- é£Ÿæ•°è¡¨ç¤ºçª“ -->
      <fieldset class="propose-group" id="counterContainer" style="display:none;">
        <legend>é£Ÿæ•°è¡¨ç¤ºçª“</legend>
        <div class="counter">
          <button id="leftBtn">â†</button>
          <span id="counterValue">1</span>
          <button id="rightBtn">â†’</button>
        </div>
      </fieldset>

      <!-- ä½¿ã„ãŸã„é­š -->
      <fieldset class="propose-group">
        <legend>ä½¿ã„ãŸã„é­šé¸æŠ</legend>
        <label><input type="radio" name="includeFishMode" value="none" checked> æŒ‡å®šã—ãªã„</label>
        <label><input type="radio" name="includeFishMode" value="specify"> æŒ‡å®šã™ã‚‹</label>
        <div id="includeFishContainer" style="margin-top:10px;display:none;"></div>
      </fieldset>

      <!-- é™¤å¤–ã™ã‚‹é­š -->
      <fieldset class="propose-group">
        <legend>é™¤å¤–ã™ã‚‹é­šé¸æŠ</legend>
        <label><input type="radio" name="excludeFishMode" value="none" checked> æŒ‡å®šã—ãªã„</label>
        <label><input type="radio" name="excludeFishMode" value="specify"> æŒ‡å®šã™ã‚‹</label>
        <div id="excludeFishContainer" style="margin-top:10px;display:none;"></div>
      </fieldset>

      <!-- é›£æ˜“åº¦ -->
      <fieldset class="propose-group">
        <legend>é›£æ˜“åº¦é¸æŠ</legend>
        <label><input type="radio" name="difficulty" value=""> åˆ¶é™ãªã—</label>
        <label><input type="radio" name="difficulty" value="1"> Lv1ä»¥ä¸‹</label>
        <label><input type="radio" name="difficulty" value="2"> Lv2ä»¥ä¸‹</label>
        <label><input type="radio" name="difficulty" value="3"> Lv3ä»¥ä¸‹</label>
        <label><input type="radio" name="difficulty" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
        <div id="customDiffInputContainer" style="margin-top:10px;display:none;">
          <input type="number" id="customDiffInput" min="1" max="5" placeholder="æœ€å¤§é›£æ˜“åº¦">
        </div>
      </fieldset>

      <!-- æ™‚é–“ -->
      <fieldset class="propose-group">
        <legend>æ™‚é–“é¸æŠ (åˆ†)</legend>
        <label><input type="radio" name="time" value=""> åˆ¶é™ãªã—</label>
        <label><input type="radio" name="time" value="15"> 15åˆ†ä»¥å†…</label>
        <label><input type="radio" name="time" value="30"> 30åˆ†ä»¥å†…</label>
        <label><input type="radio" name="time" value="60"> 60åˆ†ä»¥å†…</label>
        <label><input type="radio" name="time" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
        <div id="customTimeInputContainer" style="margin-top:10px;display:none;">
          <input type="number" id="customTimeInput" min="1" max="120" placeholder="æœ€å¤§æ™‚é–“">
        </div>
      </fieldset>

      <!-- è²»ç”¨ -->
      <fieldset class="propose-group">
        <legend>è²»ç”¨é¸æŠ (å††)</legend>
        <label><input type="radio" name="cost" value=""> åˆ¶é™ãªã—</label>
        <label><input type="radio" name="cost" value="500"> Â¥500ä»¥ä¸‹</label>
        <label><input type="radio" name="cost" value="1000"> Â¥1000ä»¥ä¸‹</label>
        <label><input type="radio" name="cost" value="2000"> Â¥2000ä»¥ä¸‹</label>
        <label><input type="radio" name="cost" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
        <div id="customCostInputContainer" style="margin-top:10px;display:none;">
          <input type="number" id="customCostInput" min="100" max="5000" placeholder="æœ€å¤§è²»ç”¨">
        </div>
      </fieldset>
    </div>

    <!-- å³å´ï¼šã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ« -->
    <div id="summaryPanel">
      <h3>ğŸ± å„é£Ÿã®è¨­å®š</h3>
      <div id="mealSummary"></div>
    </div>
  </div>
</div>


    
<script>
/*
 * æœ€çµ‚ä¿®æ­£ç‰ˆ: é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å³å¯†ãªANDæ¡ä»¶ (b âŠ† a) ã«å¤‰æ›´ ï¼‹ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„å¯¾å¿œ
 * ï¼‹ çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã€Œä¸‹å‡¦ç† (pre)ã€ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚‚é©ç”¨
 */

(function(){
    const tryPaths = [
        'docs/recipes.json',
        './docs/recipes.json',
        '/recipes.json',
        './recipes.json'
    ];

    // â˜…â˜…â˜… ãƒªã‚¹ãƒˆ/ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢é€£ã®è¦ç´  (æ—¢å­˜ã®HTMLè¦ç´ ã‚’ä½¿ç”¨) â˜…â˜…â˜…
    const wrap = document.getElementById('wrap');
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const filterType = document.getElementById('filterType');
    const sortBy = document.getElementById('sortBy');
    const reloadBtn = document.getElementById('reloadBtn');
    const message = document.getElementById('message');

    // â˜…â˜…â˜… æ–°ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´  (HTMLã¸ã®è¿½åŠ ãŒå¿…è¦ã§ã™) â˜…â˜…â˜…
    const filterOpenBtn = document.getElementById('filterOpenBtn'); 
    const filterModal = document.getElementById('filterModal');     
    const filterContent = document.getElementById('filterContent'); 
    const applyFilterBtn = document.getElementById('applyFilterBtn'); 
    const filterClearBtn = document.getElementById('filterClearBtn'); 
    
    // â˜…â˜…â˜… è©³ç´°ã‚³ãƒ³ãƒ†ãƒŠã®è¦ç´  â˜…â˜…â˜…
    const detailTitle = document.getElementById('detailTitle');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailImageContainer = document.getElementById('detailImageContainer');
    const detailMeta = document.getElementById('detailMeta');
    const detailIngredients = document.getElementById('detailIngredients');
    const detailRecipe = document.getElementById('detailRecipe');
    const detailMemo = document.getElementById('detailMemo');
    const backToListBtn = document.getElementById('backToListBtn');
    const detailProps = document.getElementById('detailProps');
    const propsSection = document.getElementById('propsSection');

    let rawData = null;
    let flatList = []; // merged list with type annotation
    
    // ãƒ•ã‚£ãƒ«ã‚¿ã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (é­šç¨®ã¯Setã€é›£æ˜“åº¦/æ™‚é–“/è²»ç”¨ã¯å˜ä¸€ã®å€¤)
    let activeFilters = {
        'fish-name': new Set(), // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å½¢å¼ (è¤‡æ•°é¸æŠ)
        difficulty: null,       // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å½¢å¼ (å˜ä¸€å€¤)
        time: null,             // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³/å…¥åŠ›å½¢å¼ (å˜ä¸€å€¤)
        cost: null              // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³/å…¥åŠ›å½¢å¼ (å˜ä¸€å€¤)
    };
    // å›ºå®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const DIFFICULTY_OPTIONS = ['1', '2', '3', '4', '5'];
    const TIME_OPTIONS = [15, 30, 60]; 
    const COST_OPTIONS = [500, 1000, 2000];
    const TIME_MAX = 120; // å…¥åŠ›æ¬„ã®æœ€å¤§å€¤
    const COST_MAX = 5000; // å…¥åŠ›æ¬„ã®æœ€å¤§å€¤


    // Utility: safe text node creation
    function elText(tag, text, cls){
        const el = document.createElement(tag);
        if (cls) el.className = cls;
        el.textContent = (text === undefined || text === null) ? '' : String(text);
        return el;
    }

    // Try fetching from multiple paths in order
    async function fetchAny(paths){
        for (const p of paths){
            try {
                const res = await fetch(p, {cache: "no-store"});
                if (!res.ok) continue;
                const json = await res.json();
                return json;
            } catch(e){
                console.warn('fetch failed for', p, e);
            }
        }
        throw new Error('recipes.json ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æœŸå¾…ã™ã‚‹å ´æ‰€: ' + paths.join(', '));
    }

    // Normalize and flatten recipes + preparations into an array for table
    function buildFlatList(data){
        const list = [];
        if (!data || typeof data !== 'object') return list;

        const recipes = data.recipes || {};
        for (const key of Object.keys(recipes)){
            const item = Object.assign({}, recipes[key]);
            item._type = 'recipe';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        const pres = data.preparations || {};
        for (const key of Object.keys(pres)){
            const item = Object.assign({}, pres[key]);
            item._type = 'pre';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        return list;
    }

    // safe join array-like fields for display
    function joinIfArray(val){
        if (Array.isArray(val)) return val.join(', ');
        if (val === undefined || val === null) return '';
        return String(val);
    }

    function clearTable(){ 
        if(tbody) tbody.innerHTML = ''; 
    }

    /**
     * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (é­šç¨®ç”¨)
     */
    function createCheckboxGroup(title, key, values, hintText = '') {
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';

        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);

        if (hintText) {
             const hint = elText('p', hintText, 'filter-hint');
             fieldset.appendChild(hint);
        }

        values.forEach(value => {
            const strValue = String(value);
            const id = `${key}-${strValue.replace(/[^a-zA-Z0-9]/g, '-')}`;

            const div = document.createElement('div');
            div.className = 'filter-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = strValue;
            checkbox.dataset.filterKey = key;
            
            // activeFiltersã«å€¤ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ãƒã‚§ãƒƒã‚¯
            if (activeFilters[key] && activeFilters[key].has(strValue)) {
                checkbox.checked = true;
            }

            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = strValue;

            div.appendChild(checkbox);
            div.appendChild(label);
            fieldset.appendChild(div);
        });
        return fieldset;
    }

    /**
     * ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (é›£æ˜“åº¦/æ™‚é–“/è²»ç”¨ç”¨)
     * @param {string} type - 'radio' or 'radio-input'
     */
    function createRadioGroup(title, key, values, hintText = '', labels = null, type = 'radio', inputProps = {}) {
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';

        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);

        if (hintText) {
             const hint = elText('p', hintText, 'filter-hint');
             fieldset.appendChild(hint);
        }
        
        // ----------------- ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ç¾¤ -----------------
        const radioDiv = document.createElement('div');
        radioDiv.className = 'radio-options-container';

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³: ã€Œåˆ¶é™ãªã—ã€
        const allRadioDiv = document.createElement('div');
        allRadioDiv.className = 'filter-item';
        const allId = `${key}-all`;
        const allRadio = document.createElement('input');
        allRadio.type = 'radio';
        allRadio.id = allId;
        allRadio.name = key;
        allRadio.value = ''; // ç©ºæ–‡å­—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤ã‚’ç¤ºã™
        allRadio.dataset.filterKey = key;
        
        // activeFilters[key]ãŒnullã¾ãŸã¯ç©ºæ–‡å­—ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã™ã‚‹
        if (activeFilters[key] === null || activeFilters[key] === '') {
            allRadio.checked = true;
        }

        const allLabel = document.createElement('label');
        allLabel.htmlFor = allId;
        allLabel.textContent = 'åˆ¶é™ãªã—';
        allRadioDiv.appendChild(allRadio);
        allRadioDiv.appendChild(allLabel);
        radioDiv.appendChild(allRadioDiv);

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³: å®šç¾©æ¸ˆã¿ã®å€¤
        values.forEach((value, index) => {
            const strValue = String(value);
            const id = `${key}-${strValue}`;
            const labelText = labels ? labels[index] : strValue;

            const div = document.createElement('div');
            div.className = 'filter-item';

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = id;
            radio.name = key;
            radio.value = strValue;
            radio.dataset.filterKey = key;
            
            // activeFilters[key]ãŒã“ã®å€¤ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            if (activeFilters[key] === strValue) {
                radio.checked = true;
            }

            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = labelText;

            div.appendChild(radio);
            div.appendChild(label);
            radioDiv.appendChild(div);
        });
        
        // ----------------- ã‚«ã‚¹ã‚¿ãƒ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ (æ™‚é–“ã¨è²»ç”¨ã®ã¿) -----------------
        let inputContainer = null;
        if (type === 'radio-input') {
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const customRadioDiv = document.createElement('div');
            customRadioDiv.className = 'filter-item';
            const customId = `${key}-custom-radio`;
            const customRadio = document.createElement('input');
            customRadio.type = 'radio';
            customRadio.id = customId;
            customRadio.name = key;
            customRadio.value = 'CUSTOM';
            customRadio.dataset.filterKey = key;
            
            // activeFiltersã«æ•°å­—ãŒæ ¼ç´ã•ã‚Œã¦ãŠã‚Šã€ã‹ã¤ãã‚ŒãŒå®šç¾©æ¸ˆã¿ã®å€¤ã§ãªã‘ã‚Œã°ã€CUSTOMãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
            const isCustomSelected = activeFilters[key] !== null && activeFilters[key] !== '' && !values.map(String).includes(activeFilters[key]);
            if (isCustomSelected) {
                customRadio.checked = true;
            }
            
            const customLabel = document.createElement('label');
            customLabel.htmlFor = customId;
            customLabel.textContent = 'ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’å…¥åŠ›';
            customRadioDiv.appendChild(customRadio);
            customRadioDiv.appendChild(customLabel);
            radioDiv.appendChild(customRadioDiv);
            
            fieldset.appendChild(radioDiv); // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å…¨ã¦ã‚’ fieldset ã«è¿½åŠ 
            

            // ----------------- ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -----------------
            inputContainer = document.createElement('div');
            inputContainer.className = 'filter-input-container';
            inputContainer.style.marginTop = '10px';
            inputContainer.style.borderTop = '1px dashed #e2e8f0';
            inputContainer.style.paddingTop = '10px';
            // CUSTOMãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã€éè¡¨ç¤ºã«ã™ã‚‹
            if (!isCustomSelected) {
                inputContainer.style.display = 'none';
            }

            const inputId = `${key}-custom-input`;
            const labelText = (key === 'time') ? 'åˆ†' : 'å††';

            const input = document.createElement('input');
            input.type = 'number';
            input.id = inputId;
            input.name = `${key}-custom`;
            input.placeholder = `æœ€å¤§å€¤ (${inputProps.max})`;
            input.min = inputProps.min || 1;
            input.max = inputProps.max || 9999;
            input.style.width = '120px';
            input.style.padding = '6px 10px';
            input.style.borderRadius = '6px';
            input.style.border = '1px solid #d6d8df';
            input.dataset.filterKey = key;
            input.dataset.inputType = 'custom';

            if (isCustomSelected) {
                input.value = activeFilters[key];
            }
            
            const label = document.createElement('label');
            label.htmlFor = inputId;
            label.textContent = `ä»¥ä¸‹ã®æœ€å¤§å€¤ã‚’è¨­å®š (${labelText}ä»¥ä¸‹): `;
            label.style.fontWeight = 'normal';
            label.style.marginRight = '5px';

            inputContainer.appendChild(label);
            inputContainer.appendChild(input);
            fieldset.appendChild(inputContainer);
        } else {
            fieldset.appendChild(radioDiv); // radioã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã€ã“ã“ã§è¿½åŠ 
        }

        return fieldset;
    }


    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¨­å®šã¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
     * @param {Array} list - flatList
     */
    function setupFilterModal(list){
        if (!filterContent) return; 

        filterContent.innerHTML = '';
        const fragment = document.createDocumentFragment();

        // 1. é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (fish-name) - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆè¤‡æ•°é¸æŠï¼‰
        const fishSet = new Set();
        list.forEach(item => {
            if (Array.isArray(item['fish-name'])) { // pre/recipe ä¸¡æ–¹ã‹ã‚‰é­šç¨®åã‚’åé›†
                item['fish-name'].forEach(fish => {
                    const trimmedFish = fish.trim();
                    if (trimmedFish) fishSet.add(trimmedFish);
                });
            }
        });
        const uniqueFish = Array.from(fishSet).sort();
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ANDæ¡ä»¶ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
        fragment.appendChild(createCheckboxGroup('é­šç¨®', 'fish-name', uniqueFish, 'ãƒ¬ã‚·ãƒ”/ä¸‹å‡¦ç†ã«ä½¿ã†é­šãŒã€é¸æŠã—ãŸé­šç¨®ã®ã™ã¹ã¦ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’è¡¨ç¤º (b âŠ† a)'));

        // 2. é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (difficulty) - ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆå˜ä¸€é¸æŠï¼‰
        fragment.appendChild(createRadioGroup('é›£æ˜“åº¦ (æœ€å¤§)', 'difficulty', DIFFICULTY_OPTIONS, 'é¸æŠã—ãŸé›£æ˜“åº¦ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', DIFFICULTY_OPTIONS.map(d => `é›£æ˜“åº¦ ${d} ä»¥ä¸‹`)));

        // 3. æ‰€è¦æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (time) - ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‹ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„
        fragment.appendChild(createRadioGroup('æ‰€è¦æ™‚é–“ (åˆ†ãƒ»æœ€å¤§)', 'time', TIME_OPTIONS, 'é¸æŠè‚¢ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã§æŒ‡å®šã—ãŸæ™‚é–“ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', TIME_OPTIONS.map(t => `${t}åˆ†ä»¥å†…`), 'radio-input', {min: 1, max: TIME_MAX}));

        // 4. è²»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (cost) - ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‹ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„
        fragment.appendChild(createRadioGroup('è²»ç”¨ (å††ãƒ»æœ€å¤§)', 'cost', COST_OPTIONS, 'é¸æŠè‚¢ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã§æŒ‡å®šã—ãŸè²»ç”¨ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', COST_OPTIONS.map(c => `Â¥${c}ä»¥ä¸‹`), 'radio-input', {min: 100, max: COST_MAX}));

        filterContent.appendChild(fragment);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
        filterContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateActiveFilters);
        });
        filterContent.querySelectorAll('input[type="radio"], input[type="number"]').forEach(input => {
            input.addEventListener('change', handleRadioInputChange);
            input.addEventListener('input', handleRadioInputChange);
        });
    }

    /**
     * ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³/å…¥åŠ›æ¬„ã®å¤‰æ›´ã‚’å‡¦ç†ã—ã€å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹
     */
    function handleRadioInputChange(event) {
        const input = event.target;
        const key = input.dataset.filterKey;

        if (key === 'time' || key === 'cost') {
            const customContainer = filterContent.querySelector(`.filter-input-container input[data-filter-key="${key}"]`).parentNode;

            if (input.type === 'radio') {
                if (input.value === 'CUSTOM') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                    customContainer.querySelector('input[type="number"]').value = '';
                }
            }
        }
        
        updateActiveFilters();
    }


    /**
     * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³/å…¥åŠ›æ¬„ã®çŠ¶æ…‹ã‚’ activeFilters ã«åæ˜ ã™ã‚‹
     */
    function updateActiveFilters() {
        // fish-name ã¯ Setã‚’å†æ§‹ç¯‰
        activeFilters['fish-name'].clear();
        filterContent.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            if (checkbox.dataset.filterKey === 'fish-name') {
                activeFilters['fish-name'].add(checkbox.value);
            }
        });
        
        // difficulty, time, cost ã¯å˜ä¸€ã®å€¤ã‚’è¨­å®š
        ['difficulty', 'time', 'cost'].forEach(key => {
            activeFilters[key] = null; // ã¾ãšãƒªã‚»ãƒƒãƒˆ

            // 1. ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å€¤ã‚’å–å¾—
            const checkedRadio = filterContent.querySelector(`input[type="radio"][name="${key}"]:checked`);
            if (checkedRadio) {
                if (checkedRadio.value === '') {
                    // åˆ¶é™ãªã—
                    activeFilters[key] = null;
                } else if (checkedRadio.value === 'CUSTOM') {
                    // ã‚«ã‚¹ã‚¿ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€å…¥åŠ›æ¬„ã®å€¤ã‚’æ¡ç”¨
                    const customInput = filterContent.querySelector(`input[type="number"][data-filter-key="${key}"][data-input-type="custom"]`);
                    const val = parseFloat(customInput.value);
                    if (!isNaN(val) && val > 0) {
                        activeFilters[key] = String(val);
                    }
                } else {
                    // å®šç¾©æ¸ˆã¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    activeFilters[key] = checkedRadio.value;
                }
            }
        });
    }
    
    // render table rows from list
    function renderTable(list){
        clearTable();
        if (!tbody) return; 

        if (!Array.isArray(list) || list.length === 0){
            tbody.innerHTML = '<tr><td colspan="8" class="muted" style="padding:20px;text-align:center">è¡¨ç¤ºã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            return;
        }
        const fragment = document.createDocumentFragment();
        for (const item of list){
            const tr = document.createElement('tr');

            // No
            const tdNo = document.createElement('td');
            tdNo.textContent = item.No || '-';
            tr.appendChild(tdNo);

            // Type
            const tdType = document.createElement('td');
            const span = document.createElement('span');
            span.className = 'tag-type ' + (item._type === 'pre' ? 'type-pre' : 'type-recipe');
            span.textContent = item._type;
            tdType.appendChild(span);
            tr.appendChild(tdType);

            // Picture
            const tdPicture = document.createElement('td');
            const img = document.createElement('img');
            img.className = 'recipe-thumb';
            const firstPic = (Array.isArray(item.pictures) && item.pictures.length > 0) ? item.pictures[0] : null;
            let imgSrc = firstPic && typeof firstPic === 'string' ? firstPic : 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';
            img.src = imgSrc;
            img.alt = item.title || 'ç”»åƒ';
            img.style.width = '80px'; 
            img.style.height = '60px'; 
            img.style.objectFit = 'cover'; 
            tdPicture.appendChild(img);
            tr.appendChild(tdPicture);

            // Title and flavortxt
            const tdTitle = document.createElement('td');
            const title = elText('div', item.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)', ''); title.style.fontWeight='700';
            const flav = elText('div', item.flavortxt || '', 'muted');
            tdTitle.appendChild(title);
            tdTitle.appendChild(flav);
            tr.appendChild(tdTitle);

            // fish / season
            const tdFish = document.createElement('td');
            tdFish.appendChild(elText('div', joinIfArray(item['fish-name']) || '-', ''));
            tdFish.appendChild(elText('div', joinIfArray(item.season) || '', 'muted'));
            tr.appendChild(tdFish);

            // difficulty / time
            const tdDiff = document.createElement('td');
            tdDiff.appendChild(elText('div', 'é›£æ˜“åº¦: ' + (item.difficulty != null ? item.difficulty : '-')));
            tdDiff.appendChild(elText('div', 'æ‰€è¦: ' + (item.time != null ? item.time + 'åˆ†' : '-'), 'muted'));
            tr.appendChild(tdDiff);

            // cost / info line
            const tdCost = document.createElement('td');
            tdCost.appendChild(elText('div', 'Â¥' + (item.cost != null ? item.cost : '-')));
            const infoLine = (item._type === 'recipe')
                ? ('é£Ÿäº‹: ' + (item.timing || '-'))
                : ('ç‰¹å¾´: ' + joinIfArray(item.feature));
            tdCost.appendChild(elText('div', infoLine, 'muted'));
            tr.appendChild(tdCost);

            // actions
            const tdActions = document.createElement('td');
            tdActions.className = 'actions';

            // è©³ç´°ãƒœã‚¿ãƒ³
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'è©³ç´°';
            viewBtn.addEventListener('click', ()=> {
                displayDetail(item);
            });
            tdActions.appendChild(viewBtn);

            // å°åˆ·ãƒœã‚¿ãƒ³
            const printBtn = document.createElement('button');
            printBtn.textContent = 'å°åˆ·';
            printBtn.style.background = '#a0aec0'; 
            printBtn.addEventListener('click', ()=> {
                displayDetail(item);
                setTimeout(() => {
                    window.print();
                }, 500); 
            });
            tdActions.appendChild(printBtn);

            tr.appendChild(tdActions);
            fragment.appendChild(tr);
        }
        tbody.appendChild(fragment);
    }
    
    // Utility: ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createPictureElement(src, altText, maxHeight = '250px') {
        if (!src || src === 'null' || src === '') return null;

        const img = document.createElement('img');
        img.src = src;
        img.alt = altText || 'ç”»åƒ';

        img.style.maxWidth = '100%';
        img.style.maxHeight = maxHeight;
        img.style.width = 'auto';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '4px';
        img.style.display = 'block';
        img.style.margin = '0 auto';

        return img;
    }

    // è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayDetail(item){
        if(!detailTitle || !detailSubtitle || !detailMeta || !detailImageContainer || !detailIngredients || !detailRecipe || !detailMemo || !propsSection) {
            console.error("Missing detail element(s) in HTML.");
            return;
        }

        if (wrap) {
            wrap.classList.remove('list-view');
            wrap.classList.add('detail-view');
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });

        const pictures = item.pictures || [];
        const thumbPic = pictures[0] || 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';

        detailTitle.textContent = (item.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)') + ' â€” No.' + item.No;
        detailSubtitle.textContent = item.flavortxt || '';

        detailMeta.innerHTML = '';
        detailMeta.appendChild(elText('div', 'ã‚¿ã‚¤ãƒ—: ' + (item._type || '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'é­š: ' + joinIfArray(item['fish-name']) , 'pill'));
        detailMeta.appendChild(elText('div', 'æ—¬: ' + joinIfArray(item.season), 'pill'));
        detailMeta.appendChild(elText('div', 'é›£æ˜“åº¦: ' + (item.difficulty != null ? item.difficulty : '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'è²»ç”¨: ' + (item.cost != null ? 'Â¥' + item.cost : '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'æ‰€è¦æ™‚é–“: ' + (item.time != null ? item.time + 'åˆ†' : '-'), 'pill'));

        if (item._type === 'recipe') {
            const preRecipeNo = item['pre-recipe'] ? String(item['pre-recipe']) : null;

            if (preRecipeNo) {
                const preItem = flatList.find(i => i._type === 'pre' && String(i.No) === preRecipeNo);

                if (preItem) {
                    const preBtn = document.createElement('button');
                    preBtn.textContent = 'ä¸‹å‡¦ç†: ' + (preItem.title || preItem.No); 
                    preBtn.className = 'pill pre-link-pill';
                    preBtn.style.cursor = 'pointer'; 

                    preBtn.addEventListener('click', ()=> displayDetail(preItem)); 
                    detailMeta.appendChild(preBtn);
                } else {
                    detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†: No.' + preRecipeNo + ' (æœªç™ºè¦‹)', 'pill'));
                }
            } else {
                 detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†: ãªã—', 'pill'));
            }
        } else if (item._type === 'pre') {
             detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†', 'pill'));
        }

        detailImageContainer.innerHTML = '';
        const mainImg = createPictureElement(thumbPic, item.title, '250px');
        if (mainImg) {
            mainImg.style.border = '1px solid #ddd';
            mainImg.style.borderRadius = '8px';
            detailImageContainer.appendChild(mainImg);
        }

        detailIngredients.innerHTML = '';
        const ing = item.ingredients || {};

        if (Object.keys(ing).length === 0){
            detailIngredients.appendChild(elText('div','(ææ–™ãªã—)','muted'));
        } else {
            const ul = document.createElement('ul');
            for (const k of Object.keys(ing)){
                const li = document.createElement('li');
                li.textContent = k + ': ' + (ing[k] || '');
                ul.appendChild(li);
            }
            detailIngredients.appendChild(ul);
        }

        detailProps.innerHTML = '';
        const props = item.props || {};

        if (item._type === 'pre') {
            if (propsSection) propsSection.style.display = 'block';

            if (Object.keys(props).length === 0){
                detailProps.appendChild(elText('div', '(é“å…·ãªã—)', 'muted'));
            } else {
                const ul = document.createElement('ul');
                for (const k of Object.keys(props)){
                    const li = document.createElement('li');
                    li.textContent = props[k] || '';
                    ul.appendChild(li);
                }
                detailProps.appendChild(ul);
            }
        } else {
            if (propsSection) propsSection.style.display = 'none';
        }

        detailRecipe.innerHTML = '';
        const rec = item.recipe || [];

        if (!Array.isArray(rec) || rec.length === 0){
            detailRecipe.appendChild(elText('div','(æ‰‹é †ãªã—)','muted'));
        } else {
            const gridContainer = document.createElement('div');
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
            gridContainer.style.gap = '10px';
            
            for (let i = 0; i < rec.length; i++){
                const step = rec[i];
                const stepNo = i + 1;

                const card = document.createElement('div');
                card.className = 'recipe-step-card'; 
                card.style.border = '1px solid #dee2e6'; 
                card.style.padding = '15px';
                card.style.borderRadius = '6px';
                card.style.background = 'var(--card)';
                card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';

                const stepPicIndex = i + 1;
                const stepPicSrc = pictures[stepPicIndex];

                if (stepPicSrc && stepPicSrc !== 'null' && stepPicSrc !== '') {
                    const picContainer = document.createElement('div');
                    picContainer.className = 'recipe-step-picture';
                    const stepImg = createPictureElement(stepPicSrc, `æ‰‹é †${stepNo}ã®ç”»åƒ`, '150px');

                    if (stepImg) {
                        picContainer.appendChild(stepImg);
                        card.appendChild(picContainer);
                    }
                }

                const p = document.createElement('p');
                p.innerHTML = `<span style="font-weight:bold; color:var(--accent);">${stepNo}.</span> ${step}`;
                card.appendChild(p);

                gridContainer.appendChild(card);
            }
            
            detailRecipe.appendChild(gridContainer);
        }

        detailMemo.innerHTML = '';
        const memo = item.memo || [];
        if (!Array.isArray(memo) || memo.length === 0){
            detailMemo.appendChild(elText('div','(ãƒ¡ãƒ¢ãªã—)','muted'));
        } else {
            const ulm = document.createElement('ul');
            for (const m of memo){
                ulm.appendChild(elText('li', m));
            }
            detailMemo.appendChild(ulm);
        }
    }


    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»ã™ã‚‹
     */
    function applyFiltersAndRender(){
        if(!qInput || !filterType || !sortBy || !message) { return; }

        const q = (qInput.value || '').trim().toLowerCase();
        const type = filterType.value;
        const sortVal = sortBy.value;

        let list = flatList.slice();

        // 1. ã‚¿ã‚¤ãƒ—ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (type !== 'all') list = list.filter(i => i._type === type);

        // 2. æ¤œç´¢ (Search)
        if (q){
            list = list.filter(item => {
                const parts = [
                    item.title, item.flavortxt,
                    joinIfArray(item['fish-name']),
                    joinIfArray(item.feature),
                    joinIfArray(item.season),
                    item.No,
                    Object.keys(item.ingredients || {}).join(' '),
                    joinIfArray(item.recipe),
                    joinIfArray(item.memo),
                    joinIfArray(item.props)
                ];
                const hay = parts.filter(Boolean).join(' ').toLowerCase();
                return hay.includes(q);
            });
        }

        // â˜…â˜…â˜… 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã®é©ç”¨ (ä¸‹å‡¦ç†ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚‚é©ç”¨) â˜…â˜…â˜…
        list = list.filter(item => {
            // NOTE: item._type === 'pre' ã®ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€
            // ä¸‹å‡¦ç†ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚‚é­šç¨®ã€é›£æ˜“åº¦ã€æ™‚é–“ã€è²»ç”¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚

            // --- é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (fish-name) - ANDæ¡ä»¶ (b âŠ† a) ---
            const activeFish = activeFilters['fish-name']; // a: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸé­šç¨®ãƒªã‚¹ãƒˆ (Set)
            if (activeFish.size > 0) {
                // b: ãƒ¬ã‚·ãƒ”/ä¸‹å‡¦ç†ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹é­šç¨®ã‚’å–å¾—ã—ã€æ•´å½¢
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => f.trim()) : [];
                
                // b âŠ† a ã®ãƒã‚§ãƒƒã‚¯: ãƒ¬ã‚·ãƒ”/ä¸‹å‡¦ç†ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹é­š (b) ã™ã¹ã¦ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠè‚¢ (a) ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
                const allMatch = itemFish.every(f => activeFish.has(f));
                
                // itemFishãŒç©ºã®é…åˆ—ã®å ´åˆ (é­šç¨®ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¤ãƒ†ãƒ )ã€every()ã¯trueã‚’è¿”ã™ãŸã‚é€šé
                if (!allMatch) return false;
            }

            // --- é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (difficulty) - æœ€å¤§å€¤æ¡ä»¶ ---
            const maxDiff = activeFilters.difficulty ? parseFloat(activeFilters.difficulty) : null;
            if (maxDiff !== null && item.difficulty != null) {
                const itemDiff = parseFloat(item.difficulty);
                if (!isNaN(itemDiff) && itemDiff > maxDiff) return false;
            }

            // --- æ‰€è¦æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (time) - æœ€å¤§å€¤æ¡ä»¶ ---
            const maxTime = activeFilters.time ? parseFloat(activeFilters.time) : null;
            if (maxTime !== null && item.time != null) {
                const itemTime = parseFloat(item.time);
                if (!isNaN(itemTime) && itemTime > maxTime) return false;
            }
            
            // --- è²»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (cost) - æœ€å¤§å€¤æ¡ä»¶ ---
            const maxCost = activeFilters.cost ? parseFloat(activeFilters.cost) : null;
            if (maxCost !== null && item.cost != null) {
                const itemCost = parseFloat(item.cost);
                if (!isNaN(itemCost) && itemCost > maxCost) return false;
            }

            return true;
        });
        // â˜…â˜…â˜… ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®é©ç”¨ ã“ã“ã¾ã§ â˜…â˜…â˜…


        // 4. ã‚½ãƒ¼ãƒˆ (Sort)
        const desc = sortVal.startsWith('-');
        const key = desc ? sortVal.slice(1) : sortVal;

        list.sort((a,b)=>{
            const av = a[key];
            const bv = b[key];

            if (key === 'No'){
                const extractNum = (val) => {
                    const s = String(val||'');
                    const isPre = s.startsWith('P');
                    const num = parseInt(s.replace(/^P/,'') || '0', 10);
                    return isPre ? num + 0.5 : num;
                };
                const na = extractNum(av);
                const nb = extractNum(bv);
                return desc ? nb - na : na - nb;
            }

            const an = (av == null) ? Number.POSITIVE_INFINITY : Number(av);
            const bn = (bv == null) ? Number.POSITIVE_INFINITY : Number(bv);
            if (!isFinite(an) || !isFinite(bn)){
                return desc ? String(bv).localeCompare(String(av)) : String(av).localeCompare(String(bv));
            }
            return desc ? bn - an : an - bn;
        });


        renderTable(list);
        
        let activeCount = activeFilters['fish-name'].size;
        ['difficulty', 'time', 'cost'].forEach(key => {
            if (activeFilters[key] !== null) activeCount++;
        });

        let filterText = '';
        if (activeCount > 0) {
             filterText = ` (${activeCount} ç¨®é¡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)`;
        }

        message.textContent = `${list.length} ä»¶ã®çµæœã‚’è¡¨ç¤ºä¸­ (å…¨ ${flatList.length} ä»¶)${filterText}`;
    }

    // reload button
    if(reloadBtn) {
        reloadBtn.addEventListener('click', ()=> {
            loadData();
        });
    }

    // ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    if(backToListBtn) {
        backToListBtn.addEventListener('click', ()=> {
            if(wrap) {
                wrap.classList.remove('detail-view');
                wrap.classList.add('list-view');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨æ¤œç´¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    if(qInput) qInput.addEventListener('input', ()=> applyFiltersAndRender());
    if(filterType) filterType.addEventListener('change', ()=> applyFiltersAndRender());
    if(sortBy) sortBy.addEventListener('change', ()=> applyFiltersAndRender());
    
    // â˜…â˜…â˜… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â˜…â˜…â˜…
    if (filterOpenBtn) {
        filterOpenBtn.addEventListener('click', () => {
             // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«æ¯å›ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€è¡¨ç¤ºã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
             setupFilterModal(flatList); 
             if (filterModal) filterModal.style.display = 'flex'; // flexã§è¡¨ç¤º
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ (ç°¡æ˜“çš„ãªã‚‚ã®)
        if (filterModal) {
            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal) {
                    filterModal.style.display = 'none';
                }
            });
        }
    }

    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', () => {
             updateActiveFilters(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³/å…¥åŠ›æ¬„ã®çŠ¶æ…‹ã‚’ç¢ºå®š
             applyFiltersAndRender();
             if (filterModal) filterModal.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        });
    }
    
    if (filterClearBtn) {
        filterClearBtn.addEventListener('click', () => {
             // å…¨ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
             activeFilters = {
                'fish-name': new Set(),
                difficulty: null,
                time: null,
                cost: null
             };
             // UIã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã«å†åº¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
             setupFilterModal(flatList); 
             applyFiltersAndRender();
        });
    }
    // â˜…â˜…â˜… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ã“ã“ã¾ã§ â˜…â˜…â˜…


    // main loader
    async function loadData(){
        if(message) message.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        try {
            const json = await fetchAny(tryPaths);
            rawData = json;
            flatList = buildFlatList(json);

            if (flatList.length === 0){
                if(message) message.innerHTML = '<div class="notice">recipes ã¾ãŸã¯ preparations ã®ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚docs/recipes.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
            } else {
                if(message) message.textContent = `èª­ã¿è¾¼ã¿å®Œäº† â€” åˆè¨ˆ ${flatList.length} ä»¶ï¼ˆrecipes: ${Object.keys(json.recipes||{}).length}, preparations: ${Object.keys(json.preparations||{}).length}ï¼‰`;
            }
            
            // åˆå›è¡¨ç¤º
            applyFiltersAndRender();
            if(wrap) {
                 wrap.classList.remove('detail-view');
                 wrap.classList.add('list-view');
            }
        } catch (err){
            console.error(err);
            if(message) message.innerHTML = '<div class="notice">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + String(err.message) + '</div>';
            clearTable();
            if(wrap) wrap.classList.remove('detail-view');
        }
    }

    // initial load
    loadData();

    // Expose for debug on window
    window._recipesApp = {
        loadData,
        getRaw: ()=> rawData,
        getFlat: ()=> flatList,
        activeFilters: activeFilters 
    };
})();
// ===== ãƒ¬ã‚·ãƒ”ææ¡ˆãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ =====
(function() {
  const proposeBtn = document.getElementById('proposeOpenBtn');
  const proposeModal = document.getElementById('proposeModal');
  const closeProposeBtn = document.getElementById('closeProposeBtn');
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const counterContainer = document.getElementById('counterContainer');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const counterValue = document.getElementById('counterValue');
  const mealRadios = document.querySelectorAll('input[name="meals"]');
  const customMealInput = document.getElementById('customMealInput');
  const customMealInputContainer = document.getElementById('customMealInputContainer');
  const includeFishMode = document.getElementsByName('includeFishMode');
  const excludeFishMode = document.getElementsByName('excludeFishMode');
  const includeFishContainer = document.getElementById('includeFishContainer');
  const excludeFishContainer = document.getElementById('excludeFishContainer');
  const summaryPanel = document.getElementById('summaryPanel');

  let p = 1;
  let currentCount = 1;
  let selectedInclude = new Set();
  let selectedExclude = new Set();
  let fishList = [];

  // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ =====
  proposeBtn.addEventListener('click', async () => {
    proposeModal.style.display = 'flex';
    await loadFishList();
    updateSummary();
    updateMealDependentVisibility();
  });
  closeProposeBtn.addEventListener('click', () => proposeModal.style.display = 'none');
  proposeModal.addEventListener('click', e => { if (e.target === proposeModal) proposeModal.style.display = 'none'; });

  // ===== é­šãƒªã‚¹ãƒˆå–å¾— =====
  async function loadFishList() {
    try {
      const res = await fetch("./docs/recipes.json");
      const json = await res.json();
      const fishSet = new Set();
      for (const cat of ["recipes", "preparations"]) {
        const group = json[cat];
        if (!group) continue;
        for (const key in group) {
          const entry = group[key];
          if (Array.isArray(entry["fish-name"])) entry["fish-name"].forEach(f => fishSet.add(f));
        }
      }
      fishList = Array.from(fishSet).sort();
    } catch (err) { console.error(err); }
  }

  // ===== ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æç”» =====
  function renderFishCheckboxes() {
    includeFishContainer.innerHTML = "";
    excludeFishContainer.innerHTML = "";

    fishList.forEach(f => {
      const inc = document.createElement("label");
      const incInput = document.createElement("input");
      incInput.type = "checkbox";
      incInput.value = f;
      incInput.checked = selectedInclude.has(f);
      incInput.addEventListener("change", () => {
        if (incInput.checked) selectedInclude.add(f);
        else selectedInclude.delete(f);
        // åŒã˜é­šã‚’é™¤å¤–ã‹ã‚‰è§£é™¤
        const excBox = excludeFishContainer.querySelector(`input[value="${f}"]`);
        if (incInput.checked && excBox) { excBox.checked = false; selectedExclude.delete(f); }
        updateSummary();
      });
      inc.appendChild(incInput);
      inc.append(" " + f);
      includeFishContainer.appendChild(inc);

      const exc = document.createElement("label");
      const excInput = document.createElement("input");
      excInput.type = "checkbox";
      excInput.value = f;
      excInput.checked = selectedExclude.has(f);
      excInput.addEventListener("change", () => {
        if (excInput.checked) selectedExclude.add(f);
        else selectedExclude.delete(f);
        // åŒã˜é­šã‚’ä½¿ã†ã‹ã‚‰è§£é™¤
        const incBox = includeFishContainer.querySelector(`input[value="${f}"]`);
        if (excInput.checked && incBox) { incBox.checked = false; selectedInclude.delete(f); }
        updateSummary();
      });
      exc.appendChild(excInput);
      exc.append(" " + f);
      excludeFishContainer.appendChild(exc);
    });
  }

  // ===== é£Ÿæ•°ã®è¨­å®š =====
  mealRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      if (radio.value === "custom") {
        customMealInputContainer.style.display = "block";
      } else {
        customMealInputContainer.style.display = "none";
        p = Number(radio.value);
        updateMealDependentVisibility();
        updateSummary();
      }
    });
  });

  // ã‚«ã‚¹ã‚¿ãƒ é£Ÿæ•°
  const customApplyBtn = document.createElement("button");
  customApplyBtn.textContent = "æ±ºå®š";
  customApplyBtn.style.marginLeft = "8px";
  customApplyBtn.addEventListener("click", () => {
    const val = Number(customMealInput.value || 1);
    p = val;
    updateMealDependentVisibility();
    updateSummary();
  });
  customMealInputContainer.appendChild(customApplyBtn);

  // ===== å€‹åˆ¥è¨­å®šåˆ‡ã‚Šæ›¿ãˆ =====
  modeRadios.forEach(r => {
    r.addEventListener('change', () => {
      counterContainer.style.display = (r.value === 'each' && p > 1) ? 'block' : 'none';
    });
  });

  // ===== ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ =====
  leftBtn.addEventListener("click", () => {
    if (currentCount > 1) currentCount--;
    counterValue.textContent = currentCount;
  });
  rightBtn.addEventListener("click", () => {
    if (currentCount < p) currentCount++;
    counterValue.textContent = currentCount;
  });

  // ===== é­šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ =====
  document.querySelectorAll('input[name="includeFishMode"]').forEach(r => {
    r.addEventListener("change", e => {
      if (e.target.value === "specify") {
        renderFishCheckboxes();
        includeFishContainer.style.display = "block";
      } else {
        selectedInclude.clear();
        includeFishContainer.innerHTML = "";
        includeFishContainer.style.display = "none";
      }
      updateSummary();
    });
  });
  document.querySelectorAll('input[name="excludeFishMode"]').forEach(r => {
    r.addEventListener("change", e => {
      if (e.target.value === "specify") {
        renderFishCheckboxes();
        excludeFishContainer.style.display = "block";
      } else {
        selectedExclude.clear();
        excludeFishContainer.innerHTML = "";
        excludeFishContainer.style.display = "none";
      }
      updateSummary();
    });
  });

  // ===== å¯è¦–æ€§èª¿æ•´é–¢æ•° =====
  function updateMealDependentVisibility() {
    const modeFieldset = document.querySelector('fieldset legend + label input[name="mode"]')?.closest('fieldset');
    const counter = document.getElementById("counterContainer");
    if (p === 1) {
      if (modeFieldset) modeFieldset.style.display = "none";
      if (counter) counter.style.display = "none";
    } else {
      if (modeFieldset) modeFieldset.style.display = "block";
      const eachMode = document.querySelector('input[name="mode"]:checked')?.value;
      counter.style.display = (eachMode === "each") ? "block" : "none";
    }
  }

  // ===== ã‚µãƒãƒªãƒ¼æ›´æ–° =====
  function updateSummary() {
    summaryPanel.innerHTML = "";
    const h3 = document.createElement("h3");
    h3.textContent = "è¨­å®šã‚µãƒãƒªãƒ¼";
    summaryPanel.appendChild(h3);

    if (p === 1) {
      const single = document.createElement("div");
      single.className = "summary-single";
      single.innerHTML = `
        <h4>1é£Ÿåˆ†ã®è¨­å®š</h4>
        <p><strong>ä½¿ã„ãŸã„é­š:</strong> ${Array.from(selectedInclude).join(", ") || "æŒ‡å®šãªã—"}</p>
        <p><strong>é™¤å¤–ã™ã‚‹é­š:</strong> ${Array.from(selectedExclude).join(", ") || "æŒ‡å®šãªã—"}</p>
        <p><strong>é›£æ˜“åº¦:</strong> åˆ¶é™ãªã—</p>
        <p><strong>æ™‚é–“:</strong> åˆ¶é™ãªã—</p>
        <p><strong>è²»ç”¨:</strong> åˆ¶é™ãªã—</p>
      `;
      summaryPanel.appendChild(single);
    } else {
      for (let i = 1; i <= p; i++) {
        const card = document.createElement("div");
        card.className = "summary-card";
        card.innerHTML = `
          <h4>${i}é£Ÿç›®</h4>
          <p><strong>ä½¿ã„ãŸã„é­š:</strong> ${Array.from(selectedInclude).join(", ") || "æŒ‡å®šãªã—"}</p>
          <p><strong>é™¤å¤–ã™ã‚‹é­š:</strong> ${Array.from(selectedExclude).join(", ") || "æŒ‡å®šãªã—"}</p>
          <p><strong>é›£æ˜“åº¦:</strong> åˆ¶é™ãªã—</p>
          <p><strong>æ™‚é–“:</strong> åˆ¶é™ãªã—</p>
          <p><strong>è²»ç”¨:</strong> åˆ¶é™ãªã—</p>
        `;
        summaryPanel.appendChild(card);
      }
    }
  }
})();







</script>
</body>
</html>
